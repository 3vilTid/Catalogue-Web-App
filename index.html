<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=5.0">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="description" content="Catalogue web application">

    <title>Catalogue</title>

    <style>
      :root {
        --bg: #f3f4fb;
        --surface: #ffffff;
        --surface-soft: #f7f7ff;
        --primary: #2563eb;
        --primary-soft: #e0ebff;
        --primary-dark: #1d4ed8;
        --danger: #ef4444;
        --text-main: #111827;
        --text-soft: #6b7280;
        --border-soft: #e5e7eb;
        --radius-lg: 18px;
        --radius-md: 10px;
        --radius-pill: 999px;
        --shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.12);
      }

      * {
        box-sizing: border-box;
      }

      /* Hide or style scrollbars */
      * {
        scrollbar-width: thin;
        scrollbar-color: rgba(148, 163, 184, 0.3) transparent;
      }

      *::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }

      *::-webkit-scrollbar-track {
        background: transparent;
      }

      *::-webkit-scrollbar-thumb {
        background-color: rgba(148, 163, 184, 0.3);
        border-radius: 10px;
        border: 2px solid transparent;
        background-clip: padding-box;
      }

      *::-webkit-scrollbar-thumb:hover {
        background-color: rgba(148, 163, 184, 0.5);
      }

      html, body {
        margin: 0;
        padding: 0;
        width: 100%;
        overflow-x: hidden;
        border: none;
        outline: none;
      }

      body {
        padding: 18px 12px 32px;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Inter",
          "Segoe UI", sans-serif;
        background: radial-gradient(
          circle at top left,
          #e8f0ff,
          #f9fafb 42%,
          #eef2ff
        );
        color: var(--text-main);
        min-height: 100vh;
      }

      .shell {
        max-width: 1160px;
        width: 100%;
        margin: 0 auto;
        border: none;
        outline: none;
      }

      /* Top header ----------------------------------------------------------- */

      .top-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        padding: 16px 20px 14px;
        border-radius: 20px;
        background: linear-gradient(135deg, #ffffffcc, #f3f4fffe);
        box-shadow: 0 16px 40px rgba(148, 163, 184, 0.28);
        backdrop-filter: blur(16px);
        margin-bottom: 18px;
      }

      .left-block {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      .app-name {
        font-weight: 700;
        font-size: 22px;
        letter-spacing: 0.02em;
      }

      .user-role {
        font-size: 13px;
        color: var(--text-soft);
      }

      .catalog-row {
        display: flex;
        align-items: center;
        gap: 6px;
        margin-top: 3px;
      }

      .catalog-label {
        font-size: 13px;
        color: var(--text-soft);
      }

      .catalog-name {
        font-size: 15px;
        font-weight: 600;
      }

      .catalog-edit-btn {
        border: none;
        background: transparent;
        color: var(--text-soft);
        cursor: pointer;
        border-radius: 8px;
        padding: 2px 6px;
        font-size: 13px;
      }

      .catalog-edit-btn:hover {
        background: var(--surface-soft);
      }

      .right-block {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 6px;
        font-size: 13px;
        color: var(--text-soft);
      }

      .right-block > div:first-of-type {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .user-pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px 4px 12px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.9);
        box-shadow: 0 10px 25px rgba(148, 163, 184, 0.35);
      }

      .user-email {
        font-weight: 500;
        color: var(--text-main);
      }

      .profile-badge {
        padding: 0 8px;
        border-radius: 999px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.04em;
        color: #ffffff;
        background: linear-gradient(135deg, #6366f1, #2563eb);
      }

      /* Filters row --------------------------------------------------------- */

      .filters-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 14px 18px;
        margin-bottom: 14px;
        border-radius: var(--radius-lg);
        background: rgba(255, 255, 255, 0.92);
        box-shadow: 0 10px 30px rgba(148, 163, 184, 0.35);
        gap: 12px;
      }

      .filters-left {
        display: flex;
        gap: 10px;
        align-items: center;
        position: relative;
      }

      .filters-right {
        display: flex;
        gap: 8px;
        align-items: center;
      }

      .dropdown-wrapper {
        position: relative;
        display: inline-block;
      }

      .btn-toolbar {
        height: 34px;
        border-radius: 999px;
        border: 1px solid var(--border-soft);
        background: #f3f4ff;
        font-size: 13px;
        padding: 0 14px;
        outline: none;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        cursor: pointer;
        white-space: nowrap;
      }

      .btn-toolbar:hover {
        background: #e5edff;
      }

      .btn-toolbar:focus {
        box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.35);
        border-color: #93c5fd;
      }

      .btn-primary {
        border: none;
        border-radius: 999px;
        background: linear-gradient(135deg, #2563eb, #1d4ed8);
        color: white;
        font-weight: 500;
        padding: 0 16px;
      }

      .btn-primary:hover {
        background: linear-gradient(135deg, #1d4ed8, #1e40af);
      }

      .btn-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 18px;
        height: 18px;
        padding: 0 5px;
        border-radius: 999px;
        background: #2563eb;
        color: white;
        font-size: 10px;
        font-weight: 600;
      }

      /* Dropdown menus */
      .dropdown-menu {
        position: absolute;
        top: calc(100% + 6px);
        left: 0;
        min-width: 200px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 12px 40px rgba(15, 23, 42, 0.25);
        padding: 8px;
        display: none;
        z-index: 100;
        max-height: 320px;
        overflow-y: auto;
      }

      .dropdown-menu.show {
        display: block;
      }

      .dropdown-section {
        padding: 8px 0;
      }

      .dropdown-section:not(:last-child) {
        border-bottom: 1px solid #f3f4f6;
      }

      .dropdown-section-title {
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: #9ca3af;
        padding: 4px 10px;
        margin-bottom: 4px;
      }

      .dropdown-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 7px 10px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 13px;
        color: #374151;
        transition: background 0.15s ease;
      }

      .dropdown-item:hover {
        background: #f3f4f6;
      }

      .dropdown-item.selected {
        background: #e0e7ff;
        color: #4338ca;
        font-weight: 500;
      }

      .dropdown-item input[type="checkbox"] {
        margin: 0;
        cursor: pointer;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        appearance: none;
        -webkit-appearance: none;
        border: 2px solid #d1d5db;
        background: white;
        position: relative;
      }

      .dropdown-item input[type="checkbox"]:checked {
        background: var(--primary);
        border-color: var(--primary);
      }

      .dropdown-item input[type="checkbox"]:checked::after {
        content: '';
        position: absolute;
        top: 2px;
        left: 2px;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: white;
      }

      .dropdown-divider {
        height: 1px;
        background: #e5e7eb;
        margin: 6px 0;
      }

      .dropdown-actions {
        display: flex;
        gap: 6px;
        padding: 6px 4px 2px;
      }

      .dropdown-btn {
        flex: 1;
        padding: 5px 10px;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
        background: white;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.15s ease;
      }

      .dropdown-btn:hover {
        background: #f9fafb;
      }

      .dropdown-btn.primary {
        background: #2563eb;
        color: white;
        border-color: #2563eb;
      }

      .dropdown-btn.primary:hover {
        background: #1d4ed8;
      }

      /* Filter panels ------------------------------------------------------- */

      .filter-panel {
        position: fixed;
        z-index: 50;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        background: rgba(15, 23, 42, 0.25);
      }

      .filter-panel-card {
        background: #ffffff;
        border-radius: 16px;
        padding: 14px 16px 10px;
        width: 260px;
        box-shadow: 0 20px 40px rgba(15, 23, 42, 0.45);
      }

      .filter-panel-title {
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 8px;
      }

      .filter-list {
        max-height: 180px;
        overflow-y: auto;
        font-size: 13px;
      }

      .filter-item {
        display: flex;
        align-items: center;
        gap: 6px;
        margin-bottom: 4px;
      }

      .filter-panel-footer {
        margin-top: 10px;
        display: flex;
        justify-content: space-between;
        gap: 6px;
      }

      .chip-btn {
        border-radius: 999px;
        border: 1px solid var(--border-soft);
        background: var(--surface-soft);
        font-size: 12px;
        padding: 4px 10px;
        cursor: pointer;
      }

      .chip-btn.primary {
        background: #2563eb;
        color: white;
        border: none;
      }

      /* Cards --------------------------------------------------------------- */

      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(190px, 1fr));
        gap: 18px;
        margin-top: 8px;
      }

      .card {
        overflow: hidden;
        border-radius: 18px;
        background: rgba(255, 255, 255, 0.98);
        box-shadow: 0 18px 40px rgba(148, 163, 184, 0.45);
        cursor: pointer;
        transition: transform 0.12s ease, box-shadow 0.12s ease;
      }

      .card:hover {
        transform: translateY(-3px);
        box-shadow: 0 22px 50px rgba(148, 163, 184, 0.6);
      }

      /* Progressive loading image wrapper */
      .card-img-wrapper {
        position: relative;
        width: 100%;
        height: 180px;
        overflow: hidden;
        background: #e5e7eb;
      }

      .card-img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        position: absolute;
        top: 0;
        left: 0;
      }

      .card-img.placeholder {
        filter: blur(20px);
        transform: scale(1.1);
        opacity: 1;
        transition: opacity 0.3s ease;
      }

      .card-img.full {
        opacity: 0;
        transition: opacity 0.4s ease;
      }

      .card-img.full.loaded {
        opacity: 1;
      }

      .card-body {
        padding: 10px 11px 12px;
      }

      .card-name {
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 2px;
      }

      .card-sub {
        font-size: 12px;
        color: var(--text-soft);
      }

      /* Detail view --------------------------------------------------------- */

      #detailView {
        display: none;
        margin-top: 18px;
        padding: 18px 20px 20px;
        border-radius: 20px;
        background: rgba(255, 255, 255, 0.98);
        box-shadow: var(--shadow-soft);
      }

      .detail-layout {
        display: grid;
        grid-template-columns: minmax(0, 320px) minmax(0, 1fr);
        gap: 18px;
        position: relative;
      }

      .detail-img-wrapper {
        position: relative;
        width: 100%;
        max-height: 340px;
        overflow: hidden;
        border-radius: 16px;
        background: transparent;
        box-shadow: none !important;
        border: none !important;
        outline: none !important;
      }

      .detail-img {
        width: 100%;
        max-height: 340px;
        object-fit: cover;
        border-radius: 16px;
        box-shadow: none !important;
        border: none !important;
        outline: none !important;
        display: block;
      }

      .detail-img.placeholder {
        filter: blur(20px);
        transform: scale(1.1);
        position: absolute;
        top: 0;
        left: 0;
        box-shadow: none !important;
      }

      .detail-img.full {
        position: relative;
        opacity: 0;
        transition: opacity 0.4s ease;
        box-shadow: none !important;
      }

      .detail-img.full.loaded {
        opacity: 1;
      }

      /* Hide placeholder when full image is loaded */
      .detail-img.full.loaded ~ .detail-img.placeholder {
        opacity: 0;
        transition: opacity 0.4s ease;
      }

      #detailImgContainer {
        box-shadow: none !important;
        border: none !important;
        outline: none !important;
      }

      .detail-title-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
      }

      .detail-name {
        font-size: 20px;
        font-weight: 700;
        word-wrap: break-word;
        overflow-wrap: break-word;
      }

      .detail-subtitle {
        font-size: 14px;
        color: #6b7280;
        margin-top: 4px;
        word-wrap: break-word;
        overflow-wrap: break-word;
      }

      .detail-topcorner {
        font-size: 14px;
        color: #6b7280;
        word-wrap: break-word;
        overflow-wrap: break-word;
      }

      .detail-meta {
        font-size: 12px;
        color: var(--text-soft);
        margin-bottom: 8px;
        word-wrap: break-word;
        overflow-wrap: break-word;
      }

      .detail-field {
        margin-bottom: 6px;
        font-size: 13px;
        word-wrap: break-word;
        overflow-wrap: break-word;
        white-space: normal;
      }

      .detail-label {
        font-weight: 600;
      }

      .detail-actions {
        margin-top: 10px;
        display: flex;
        gap: 8px;
      }

      .btn-secondary,
      .btn-danger {
        border-radius: 999px;
        border: none;
        padding: 6px 12px;
        font-size: 13px;
        cursor: pointer;
      }

      .btn-secondary {
        background: #f3f4ff;
        color: #374151;
      }

      .btn-danger {
        background: #ef4444;
        color: white;
      }

      .link-pill {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 3px 9px;
        border-radius: 999px;
        background: #ecfdf5;
        color: #047857;
        font-size: 12px;
        text-decoration: none;
      }

      .back-btn {
        border-radius: 999px;
        border: none;
        background: #e5edff;
        color: #1d4ed8;
        padding: 4px 10px;
        font-size: 12px;
        cursor: pointer;
        margin-bottom: 8px;
      }

      /* Add/Edit & Columns modals ------------------------------------------- */

      .modal {
        position: fixed;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        background: rgba(15, 23, 42, 0.75);
        backdrop-filter: blur(4px);
        z-index: 60;
      }

      .modal-card {
        width: 360px;
        max-height: 80vh;
        overflow-y: auto;
        background: #ffffff;
        border-radius: 16px;
        padding: 16px 18px 14px;
        box-shadow: 0 22px 55px rgba(15, 23, 42, 0.6);
      }

      .modal-box {
        background: #ffffff;
        border-radius: 16px;
        padding: 24px 28px;
        box-shadow: 0 25px 60px rgba(0, 0, 0, 0.5);
        max-height: 90vh;
        overflow-y: auto;
        min-width: 480px;
      }

      .modal-card h3 {
        margin: 0 0 10px;
        font-size: 16px;
      }

      .modal-card label {
        font-size: 12px;
        font-weight: 500;
        color: var(--text-soft);
      }

      .modal-card input {
        width: 100%;
        margin: 3px 0 10px;
        padding: 7px 9px;
        border-radius: 9px;
        border: 1px solid #d1d5db;
        font-size: 13px;
        outline: none;
      }

      .modal-card input:focus {
        border-color: #93c5fd;
        box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.4);
      }

      .modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 20px;
        padding-bottom: 16px;
        border-bottom: 1px solid #e5e7eb;
      }

      .modal-header h2 {
        margin: 0;
        font-size: 20px;
        font-weight: 600;
        color: #111827;
      }

      .modal-close-x {
        background: transparent;
        border: none;
        font-size: 24px;
        color: #9ca3af;
        cursor: pointer;
        padding: 0;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 6px;
        transition: all 0.2s;
      }

      .modal-close-x:hover {
        background: #f3f4f6;
        color: #374151;
      }

      .modal-body {
        margin-bottom: 20px;
      }

      .modal-body label {
        display: block;
        font-size: 14px;
        font-weight: 500;
        color: #374151;
        margin-bottom: 6px;
        margin-top: 16px;
      }

      .modal-body label:first-child {
        margin-top: 0;
      }

      .modal-body input[type="text"],
      .modal-body input[type="date"],
      .modal-body select {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 14px;
        color: #111827;
        background: #ffffff;
        transition: all 0.2s;
        outline: none;
      }

      .modal-body input[type="text"]:focus,
      .modal-body input[type="date"]:focus,
      .modal-body select:focus {
        border-color: #2563eb;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
      }

      .modal-body input[type="date"]::-webkit-calendar-picker-indicator {
        cursor: pointer;
        opacity: 0.6;
        padding: 4px;
        border-radius: 4px;
      }

      .modal-body input[type="date"]::-webkit-calendar-picker-indicator:hover {
        opacity: 1;
        background-color: #f3f4f6;
      }

      .modal-body input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
        accent-color: #2563eb;
      }

      .modal-body label.checkbox-label {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-top: 12px;
        cursor: pointer;
        font-weight: 400;
        color: #4b5563;
      }

      .modal-footer {
        margin-top: 24px;
        padding-top: 16px;
        border-top: 1px solid #e5e7eb;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
      }

      .btn-text {
        border: none;
        background: transparent;
        font-size: 13px;
        color: #6b7280;
        cursor: pointer;
      }

      /* Fullscreen image viewer --------------------------------------------- */

      #imgOverlay {
        position: fixed;
        inset: 0;
        background: rgba(15, 23, 42, 0.88);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 999;
      }

      #imgOverlayInner {
        position: relative;
        max-width: 100vw;
        max-height: 100vh;
        padding: 20px;
      }

      #imgOverlayImg {
        max-width: 100vw;
        max-height: 100vh;
        object-fit: contain;
        border-radius: 20px;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
        cursor: zoom-out;
      }

      #imgOverlayClose {
        position: absolute;
        top: 12px;
        right: 12px;
        border: none;
        border-radius: 999px;
        padding: 4px 9px;
        background: rgba(15, 23, 42, 0.75);
        color: #e5e7eb;
        font-size: 16px;
        cursor: pointer;
      }

      #imgOverlayClose:hover {
        background: rgba(15, 23, 42, 0.95);
      }

      /* Custom Toast Notifications ------------------------------------------ */
      
      .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 10000;
        display: flex;
        flex-direction: column;
        gap: 10px;
        pointer-events: none;
      }

      .toast {
        background: white;
        border-radius: 12px;
        padding: 14px 18px;
        box-shadow: 0 12px 40px rgba(15, 23, 42, 0.35);
        display: flex;
        align-items: center;
        gap: 10px;
        min-width: 280px;
        max-width: 400px;
        pointer-events: auto;
        animation: toastSlideIn 0.3s ease;
        border-left: 4px solid #2563eb;
      }

      .toast.success {
        border-left-color: #10b981;
      }

      .toast.error {
        border-left-color: #ef4444;
      }

      .toast.warning {
        border-left-color: #f59e0b;
      }

      .toast-icon {
        font-size: 20px;
        flex-shrink: 0;
      }

      .toast-content {
        flex: 1;
        font-size: 14px;
        color: #374151;
      }

      .toast-close {
        background: none;
        border: none;
        color: #9ca3af;
        cursor: pointer;
        font-size: 18px;
        padding: 0;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 6px;
        flex-shrink: 0;
      }

      .toast-close:hover {
        background: #f3f4f6;
        color: #374151;
      }

      @keyframes toastSlideIn {
        from {
          transform: translateX(400px);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      @keyframes toastSlideOut {
        from {
          transform: translateX(0);
          opacity: 1;
        }
        to {
          transform: translateX(400px);
          opacity: 0;
        }
      }

      .toast.hiding {
        animation: toastSlideOut 0.3s ease;
      }

      /* Custom Confirm Dialog ----------------------------------------------- */
      
      .confirm-overlay {
        position: fixed;
        inset: 0;
        background: rgba(15, 23, 42, 0.4);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        animation: fadeIn 0.2s ease;
      }

      .confirm-overlay.show {
        display: flex;
      }

      .confirm-dialog {
        background: white;
        border-radius: 16px;
        padding: 24px;
        max-width: 400px;
        width: 90%;
        box-shadow: 0 20px 60px rgba(15, 23, 42, 0.4);
        animation: scaleIn 0.2s ease;
      }

      .confirm-title {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 12px;
        color: #111827;
      }

      .confirm-message {
        font-size: 14px;
        color: #6b7280;
        margin-bottom: 20px;
        line-height: 1.5;
      }

      .confirm-actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
      }

      .confirm-btn {
        padding: 8px 16px;
        border-radius: 8px;
        border: none;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.15s ease;
      }

      .confirm-btn.cancel {
        background: #f3f4f6;
        color: #374151;
      }

      .confirm-btn.cancel:hover {
        background: #e5e7eb;
      }

      .confirm-btn.confirm {
        background: #ef4444;
        color: white;
      }

      .confirm-btn.confirm:hover {
        background: #dc2626;
      }

      /* Custom Prompt Dialog (for text input) ------------------------------- */
      
      .prompt-overlay {
        position: fixed;
        inset: 0;
        background: rgba(15, 23, 42, 0.75);
        backdrop-filter: blur(4px);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        animation: fadeIn 0.2s ease;
      }

      .prompt-overlay.show {
        display: flex;
      }

      .prompt-box,
      .prompt-dialog {
        background: white;
        border-radius: 16px;
        padding: 28px;
        max-width: 440px;
        width: 90%;
        box-shadow: 0 25px 60px rgba(0, 0, 0, 0.5);
        animation: scaleIn 0.2s ease;
      }

      .prompt-title {
        font-size: 20px;
        font-weight: 600;
        margin-bottom: 12px;
        color: #111827;
      }

      .prompt-message {
        font-size: 15px;
        color: #6b7280;
        line-height: 1.5;
        margin-bottom: 20px;
      }

      .prompt-input {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 14px;
        margin-bottom: 20px;
        outline: none;
      }

      .prompt-input:focus {
        border-color: #2563eb;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
      }

      .prompt-actions {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        margin-top: 24px;
      }

      .prompt-btn {
        padding: 10px 20px;
        border-radius: 8px;
        border: none;
        font-size: 15px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        min-width: 80px;
      }

      .prompt-btn.cancel {
        background: #f3f4f6;
        color: #374151;
        border: 1px solid #e5e7eb;
      }

      .prompt-btn.cancel:hover {
        background: #e5e7eb;
        border-color: #d1d5db;
      }

      .prompt-btn.confirm {
        background: #2563eb;
        color: white;
      }

      .prompt-btn.confirm:hover {
        background: #1d4ed8;
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
      }

      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }

      @keyframes scaleIn {
        from {
          transform: scale(0.9);
          opacity: 0;
        }
        to {
          transform: scale(1);
          opacity: 1;
        }
      }

      /* Column Management Table ----------------------------------------- */

      #columnsTable {
        font-size: 12px;
      }

      #columnsTable th {
        font-weight: 600;
        color: #374151;
        position: sticky;
        top: 0;
        background: #f3f4f6;
        z-index: 10;
      }

      #columnsTable tbody tr:hover {
        background: #f9fafb;
      }

      #columnsTable input[type="checkbox"] {
        cursor: pointer;
      }

      /* Login Screen ---------------------------------------------------- */

      #loginScreen {
        display: none;
        position: fixed;
        inset: 0;
        background: radial-gradient(circle at top left, #e8f0ff, #f9fafb 42%, #eef2ff);
        z-index: 10000;
        align-items: center;
        justify-content: center;
      }

      #loginScreen.show {
        display: flex;
      }

      .login-card {
        background: white;
        border-radius: 20px;
        padding: 40px;
        max-width: 420px;
        width: 90%;
        box-shadow: 0 20px 60px rgba(15, 23, 42, 0.2);
      }

      .login-header {
        text-align: center;
        margin-bottom: 32px;
      }

      .login-title {
        font-size: 28px;
        font-weight: 700;
        color: var(--text-main);
        margin-bottom: 8px;
      }

      .login-subtitle {
        font-size: 14px;
        color: var(--text-soft);
      }

      .login-form {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      .login-input-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .login-label {
        font-size: 13px;
        font-weight: 600;
        color: var(--text-main);
      }

      .login-input {
        padding: 12px 16px;
        border: 1px solid var(--border-soft);
        border-radius: 10px;
        font-size: 15px;
        outline: none;
        transition: all 0.2s ease;
      }

      .login-input:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
      }

      .login-input::placeholder {
        color: #9ca3af;
      }

      .login-btn {
        padding: 14px 24px;
        border: none;
        border-radius: 10px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .login-btn-primary {
        background: linear-gradient(135deg, #2563eb, #1d4ed8);
        color: white;
        box-shadow: 0 4px 14px rgba(37, 99, 235, 0.4);
      }

      .login-btn-primary:hover {
        background: linear-gradient(135deg, #1d4ed8, #1e40af);
        transform: translateY(-1px);
        box-shadow: 0 6px 20px rgba(37, 99, 235, 0.5);
      }

      .login-btn-primary:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      .login-btn-secondary {
        background: #f3f4f6;
        color: var(--text-main);
      }

      .login-btn-secondary:hover {
        background: #e5e7eb;
      }

      .login-message {
        padding: 12px 16px;
        border-radius: 8px;
        font-size: 13px;
        margin-bottom: 16px;
      }

      .login-message.success {
        background: #ecfdf5;
        color: #047857;
        border: 1px solid #a7f3d0;
      }

      .login-message.error {
        background: #fef2f2;
        color: #dc2626;
        border: 1px solid #fecaca;
      }

      .login-step {
        display: none;
      }

      .login-step.active {
        display: block;
      }

      .login-back-btn {
        margin-top: 16px;
        text-align: center;
      }

      .login-back-btn button {
        background: none;
        border: none;
        color: var(--primary);
        cursor: pointer;
        font-size: 13px;
        text-decoration: underline;
      }

      .login-back-btn button:hover {
        color: var(--primary-dark);
      }

      .login-loading {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid white;
        border-top-color: transparent;
        border-radius: 50%;
        animation: spin 0.6s linear infinite;
        margin-right: 8px;
        vertical-align: middle;
      }

      @keyframes spin {
        to { transform: rotate(360deg); }
      }

      /* ==================== RESPONSIVE DESIGN ==================== */

      /* Tablet and below (768px) */
      @media (max-width: 768px) {
        .shell {
          padding: 0 12px;
        }

        /* Stack header blocks vertically on tablets */
        .top-header {
          flex-direction: column;
          align-items: stretch;
          gap: 12px;
        }

        .right-block {
          flex-direction: row;
          justify-content: space-between;
          align-items: center;
          width: 100%;
        }

        /* Detail view: single column on tablets */
        .detail-layout {
          grid-template-columns: 1fr;
          gap: 16px;
        }

        /* Adjust grid for tablets: 3-4 columns */
        .grid {
          grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
          gap: 16px;
        }

        /* Make modals more mobile-friendly */
        .modal-box {
          max-width: 90vw !important;
          min-width: auto !important;
        }
      }

      /* Phone and Tablet (1024px and below) - Catches phones reporting 980px like Samsung Galaxy A31 */
      @media (max-width: 1024px) {
        /* Larger padding on phones for comfortable margins */
        .shell {
          padding: 0 20px;
        }

        .top-header {
          padding: 20px 20px;
          margin-bottom: 20px;
        }

        /* LARGER TEXT SIZES FOR MOBILE - PORTRAIT */
        .app-name {
          font-size: 30px !important;
          font-weight: 700 !important;
        }

        .catalog-name {
          font-size: 25px !important;
          font-weight: 600 !important;
        }

        .catalog-label,
        .user-role {
          font-size: 18px !important;
        }

        .user-email {
          font-size: 18px !important;
        }

        .profile-badge {
          font-size: 16px !important;
          padding: 2px 10px !important;
        }

        /* Grid: 3 columns in PORTRAIT */
        .grid {
          grid-template-columns: repeat(3, 1fr);
          gap: 12px;
        }

        /* BIGGER BUTTONS FOR PORTRAIT - 68px height */
        .btn-toolbar,
        .btn-primary,
        .btn-secondary {
          height: 68px !important;
          min-height: 68px !important;
          padding: 20px 28px !important;
          font-size: 19px !important;
          font-weight: 600 !important;
        }

        /* Logout button */
        #logoutBtn {
          height: 68px !important;
          min-height: 68px !important;
          padding: 0 28px !important;
          font-size: 18px !important;
        }

        /* Filter/Sort buttons */
        #filterBtn,
        #sortBtn,
        #backToListBtn {
          height: 68px !important;
          min-height: 68px !important;
          padding: 20px 28px !important;
          font-size: 19px !important;
        }

        /* Right toolbar buttons */
        #sheetBtn,
        #columnsBtn,
        #addBtn {
          height: 68px !important;
          min-height: 68px !important;
          padding: 20px 28px !important;
          font-size: 19px !important;
        }

        /* Card text bigger */
        .item-card {
          min-height: 180px;
          padding: 12px !important;
        }

        .item-name {
          font-size: 22px !important;
          line-height: 1.4;
          font-weight: 600 !important;
        }

        .item-subtitle {
          font-size: 20px !important;
          margin-top: 6px !important;
        }

        /* LANDSCAPE MODE - Smaller buttons, smaller text, 4 columns */
        @media (orientation: landscape) {
          /* Grid: 4 columns in LANDSCAPE */
          .grid {
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
          }

          /* SMALLER BUTTONS FOR LANDSCAPE - 40px */
          .btn-toolbar,
          .btn-primary,
          .btn-secondary,
          #logoutBtn,
          #filterBtn,
          #sortBtn,
          #backToListBtn,
          #sheetBtn,
          #columnsBtn,
          #addBtn {
            height: 40px !important;
            min-height: 40px !important;
            padding: 8px 16px !important;
            font-size: 14px !important;
          }

          /* Smaller header text in landscape */
          .app-name {
            font-size: 20px !important;
          }

          .catalog-name {
            font-size: 16px !important;
          }

          /* Smaller card text in landscape */
          .item-name {
            font-size: 15px !important;
          }

          .item-subtitle {
            font-size: 14px !important;
          }

          .item-card {
            min-height: 150px;
          }

          /* Detail view layout - LANDSCAPE: Restore side-by-side */
          .detail-layout {
            grid-template-columns: minmax(0, 280px) minmax(0, 1fr) !important;
            gap: 16px;
          }

          .detail-img-wrapper {
            max-height: 300px;
          }

          .detail-img {
            max-height: 300px;
          }

          /* Detail view text sizes - LANDSCAPE */
          .detail-name {
            font-size: 20px !important;
          }

          .detail-subtitle {
            font-size: 16px !important;
          }

          .detail-topcorner {
            font-size: 16px !important;
          }

          .detail-meta {
            font-size: 16px !important;
          }

          .detail-field {
            font-size: 15px !important;
          }

          .detail-field-label {
            font-size: 15px !important;
          }

          .detail-field-value {
            font-size: 15px !important;
          }
        }

        /* Stack filters row on phones */
        .filters-row {
          flex-direction: column;
          gap: 8px;
          align-items: stretch;
        }

        .filters-left,
        .filters-right {
          width: 100%;
          justify-content: flex-start;
        }

        /* Dropdown menus full width on mobile */
        .dropdown-menu {
          left: 0;
          right: 0;
          width: 100%;
        }

        /* Modal adjustments for phones */
        .modal-box {
          padding: 20px;
          max-width: 95vw !important;
        }

        .modal-header {
          font-size: 18px;
        }

        /* Form inputs touch-friendly */
        input[type="text"],
        input[type="email"],
        input[type="number"],
        input[type="date"],
        input[type="url"],
        textarea,
        select {
          min-height: 44px;
          font-size: 16px; /* Prevents zoom on iOS */
        }

        /* PORTRAIT MODE ONLY - Wrap in orientation query */
        @media (orientation: portrait) {
          /* Portrait mode shell padding */
          .shell {
            padding: 0 12px !important;
          }

          /* Ensure symmetrical margins - adjust container padding */
          #detailView {
            padding: 16px !important;
            margin-left: 0;
            margin-right: 0;
            width: 100%;
            box-sizing: border-box;
          }

          /* Detail view layout - PORTRAIT: Stack image above details */
          .detail-layout {
            grid-template-columns: 1fr !important;
            gap: 16px;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
          }

          .detail-img-wrapper {
            width: 100% !important;
            max-width: 100% !important;
            max-height: none !important;
            min-height: 300px;
            box-sizing: border-box !important;
            margin: 0 !important;
          }

          .detail-img {
            width: 100% !important;
            max-width: 100% !important;
            height: auto !important;
            max-height: none !important;
            display: block;
            object-fit: cover;
            margin: 0 !important;
          }

          /* Ensure text wraps properly */
          .detail-field,
          .detail-name,
          .detail-subtitle,
          .detail-topcorner,
          .detail-meta {
            word-break: break-word !important;
            overflow-wrap: break-word !important;
          }

          /* Make image zoom close button MUCH bigger for portrait */
          #imgOverlayClose {
            font-size: 32px !important;
            padding: 8px 14px !important;
            top: 20px !important;
            right: 20px !important;
            min-width: 48px;
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
          }

          /* Detail view text sizes - PORTRAIT */
          .detail-container {
            padding: 16px;
          }

          .detail-name {
            font-size: 30px !important;
          }

          .detail-subtitle {
            font-size: 25px !important;
          }

          /* Make the text container positioned so Top Corner positions relative to it */
          .detail-layout > div:not(#detailImgContainer) {
            position: relative;
          }

          .detail-topcorner {
            font-size: 25px !important;
            top: 0 !important;
            right: 0 !important;
          }

          .detail-meta {
            font-size: 25px !important;
          }

          .detail-field {
            font-size: 22px !important;
          }

          .detail-field-label {
            font-size: 22px !important;
          }

          .detail-field-value {
            font-size: 22px !important;
          }
        }

        /* Card adjustments - MUCH LARGER TEXT */
        .item-card {
          min-height: 180px;
          padding: 12px !important;
        }

        .item-name {
          font-size: 17px !important;
          line-height: 1.4;
          font-weight: 600 !important;
        }

        .item-subtitle {
          font-size: 16px !important;
          margin-top: 6px !important;
        }

        /* Login screen adjustments */
        .login-box {
          padding: 32px 24px;
          max-width: 95vw;
        }

        .login-title {
          font-size: 24px;
        }
      }

      /* Very small phones (600px and below) - Even more compact for actual small phones */
      @media (max-width: 600px) {
        /* Even smaller spacing */
        .shell {
          padding: 0 4px;
        }

        .top-header {
          padding: 10px 12px;
        }

        /* Grid: might go to 1 column on very small phones */
        .grid {
          grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
          gap: 10px;
        }

        /* Smaller text on tiny screens */
        .app-name {
          font-size: 18px;
        }

        .catalog-name {
          font-size: 14px;
        }

        /* Compact buttons but still touch-friendly */
        .btn-toolbar,
        .btn-primary,
        .btn-secondary {
          height: 44px !important;
          min-height: 44px !important;
          font-size: 13px !important;
          padding: 10px 12px !important;
        }

        /* Modal even more compact */
        .modal-box {
          padding: 16px;
        }
      }

      /* Large desktop (1440px and up) - optimize for big screens */
      @media (min-width: 1440px) {
        .shell {
          max-width: 1400px;
        }

        /* More columns on large screens */
        .grid {
          grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
          gap: 20px;
        }
      }

      /* Ultra-wide (1920px and up) */
      @media (min-width: 1920px) {
        .shell {
          max-width: 1600px;
        }

        .grid {
          grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
          gap: 24px;
        }
      }
    </style>
  </head>

  <body>
    <div class="shell">
      <!-- Top header -->
      <div class="top-header">
        <div class="left-block">
          <div id="appName" class="app-name">App name</div>

          <div class="catalog-row">
            <span class="catalog-label"></span>
            <span id="catalogName" class="catalog-name">Catalogue</span>
            <button id="editCatalogBtn" class="catalog-edit-btn" title="Rename catalogue" style="display: none">
              ‚úè
            </button>
          </div>
        </div>

        <div id="userInfoBlock" class="right-block">
          <div>
            <span>Signed in:</span>
            <div class="user-pill">
              <span id="userEmail" class="user-email">email</span>
              <span id="userProfilePill" class="profile-badge">ROLE</span>
            </div>
          </div>
          <button id="logoutBtn" class="btn-toolbar" style="padding: 0 12px; height: 28px; font-size: 12px;">
            Logout
          </button>
        </div>
      </div>

      <!-- Filters row -->
      <div class="filters-row">
        <div class="filters-left">
          <!-- Back to list button (hidden by default, shown in detail view) -->
          <button id="backToListBtn" class="btn-toolbar" onclick="backToList()" style="display: none;">
            ‚Üê Back to list
          </button>

          <!-- Filter button with dropdown -->
          <div id="filterWrapper" class="dropdown-wrapper">
            <button id="filterBtn" class="btn-toolbar">
              üîç Filter
              <span id="filterBadge" class="btn-badge" style="display: none;">0</span>
              <span>‚ñæ</span>
            </button>
            <div id="filterDropdown" class="dropdown-menu">
              <!-- Dynamic filter sections will be populated here -->
            </div>
          </div>

          <!-- Sort button with dropdown -->
          <div id="sortWrapper" class="dropdown-wrapper">
            <button id="sortBtn" class="btn-toolbar">
              ‚ÜïÔ∏è Sort
              <span id="sortLabel">None</span>
              <span>‚ñæ</span>
            </button>
            <div id="sortDropdown" class="dropdown-menu">
              <div class="dropdown-section">
                <div class="dropdown-section-title">Sort by</div>
                <div class="dropdown-item" data-sort="none">
                  <input type="radio" name="sortField" value="none" checked>
                  <span>No sorting</span>
                </div>
                <div class="dropdown-item" data-sort="Name">
                  <input type="radio" name="sortField" value="Name">
                  <span>Name</span>
                </div>
                <div class="dropdown-item" data-sort="Category">
                  <input type="radio" name="sortField" value="Category">
                  <span>Category</span>
                </div>
                <div class="dropdown-item" data-sort="Place">
                  <input type="radio" name="sortField" value="Place">
                  <span>Place</span>
                </div>
                <div class="dropdown-item" data-sort="Date">
                  <input type="radio" name="sortField" value="Date">
                  <span>Date</span>
                </div>
              </div>
              <div class="dropdown-divider"></div>
              <div class="dropdown-section">
                <div class="dropdown-section-title">Order</div>
                <div class="dropdown-item" data-order="asc">
                  <input type="radio" name="sortOrder" value="asc" checked>
                  <span>Ascending ‚Üë</span>
                </div>
                <div class="dropdown-item" data-order="desc">
                  <input type="radio" name="sortOrder" value="desc">
                  <span>Descending ‚Üì</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="filters-right">
          <button id="sheetLinkBtn" class="btn-toolbar" style="display: none;">üìä Sheet</button>
          <button id="columnsBtn" class="btn-toolbar" style="display: none;">‚öô Columns</button>
          <button id="addBtn" class="btn-toolbar btn-primary" style="display: none;">+ Add item</button>
        </div>
      </div>

      <!-- Cards grid & details -->
      <div id="gridView" class="grid"></div>
      <div id="detailView"></div>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen">
      <div class="login-card">
        <div class="login-header">
          <div class="login-title" id="loginAppName">Catalogue</div>
          <div class="login-subtitle">Sign in to access the catalogue</div>
        </div>

        <!-- Step 1: Enter Email -->
        <div id="loginStepEmail" class="login-step active">
          <div id="loginMessage1" class="login-message" style="display: none;"></div>
          <div class="login-form">
            <div class="login-input-group">
              <label class="login-label" for="loginEmailInput">Email Address</label>
              <input
                type="email"
                id="loginEmailInput"
                class="login-input"
                placeholder="your@email.com"
                autocomplete="email"
              >
            </div>
            <button id="loginSendCodeBtn" class="login-btn login-btn-primary">
              Send Verification Code
            </button>
          </div>
        </div>

        <!-- Step 2: Enter Code -->
        <div id="loginStepCode" class="login-step">
          <div id="loginMessage2" class="login-message" style="display: none;"></div>
          <div class="login-form">
            <div class="login-input-group">
              <label class="login-label" for="loginCodeInput">Verification Code</label>
              <input
                type="text"
                id="loginCodeInput"
                class="login-input"
                placeholder="Enter 6-digit code"
                maxlength="6"
                pattern="[0-9]*"
                inputmode="numeric"
              >
              <div style="font-size: 12px; color: var(--text-soft); margin-top: 4px;">
                Check your email for the verification code
              </div>
            </div>
            <button id="loginVerifyBtn" class="login-btn login-btn-primary">
              Verify & Sign In
            </button>
          </div>
          <div class="login-back-btn">
            <button id="loginBackBtn">‚Üê Back to email</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit Item Modal -->
    <div id="editModal" class="modal">
      <div class="modal-box" style="min-width: 520px;">
        <div class="modal-header">
          <h2 id="editModalTitle">Edit item</h2>
          <button class="modal-close-x" onclick="closeEditModal()">‚úï</button>
        </div>
        <div id="editModalBody" class="modal-body">
          <!-- Fields dynamically populated -->
        </div>
        <div class="modal-footer">
          <button id="editCancelBtn" class="btn-secondary">Cancel</button>
          <button id="editSaveBtn" class="btn-primary">Save</button>
        </div>
      </div>
    </div>

    <!-- Confirm Dialog -->
    <div id="confirmOverlay" class="prompt-overlay">
      <div class="prompt-box">
        <h3 id="confirmTitle" class="prompt-title">Confirm</h3>
        <p id="confirmMessage" class="prompt-message">Are you sure?</p>
        <div class="prompt-actions">
          <button id="confirmCancel" class="prompt-btn cancel">Cancel</button>
          <button id="confirmOk" class="prompt-btn confirm">OK</button>
        </div>
      </div>
    </div>

    <!-- Prompt Dialog -->
    <div id="promptOverlay" class="prompt-overlay">
      <div class="prompt-box">
        <h3 id="promptTitle" class="prompt-title">Input</h3>
        <p id="promptMessage" class="prompt-message">Enter value:</p>
        <input type="text" id="promptInput" class="prompt-input">
        <div class="prompt-actions">
          <button id="promptCancel" class="prompt-btn cancel">Cancel</button>
          <button id="promptOk" class="prompt-btn confirm">OK</button>
        </div>
      </div>
    </div>

    <!-- Manage Columns Modal -->
    <div id="manageColumnsModal" class="modal">
      <div class="modal-box" style="max-width: 900px;">
        <div class="modal-header">
          <h2>Manage Columns</h2>
          <button class="modal-close-x" onclick="closeManageColumnsModal()">‚úï</button>
        </div>
        <div class="modal-body" style="max-height: 500px; overflow-y: auto;">
          <table id="columnsTable" style="width: 100%; border-collapse: collapse;">
            <thead>
              <tr>
                <th style="padding: 8px; text-align: left; border-bottom: 2px solid #e5e7eb;">Order</th>
                <th style="padding: 8px; text-align: left; border-bottom: 2px solid #e5e7eb;">Column Name</th>
                <th style="padding: 8px; text-align: left; border-bottom: 2px solid #e5e7eb;">Display Name</th>
                <th style="padding: 8px; text-align: left; border-bottom: 2px solid #e5e7eb;">Type</th>
                <th style="padding: 8px; text-align: center; border-bottom: 2px solid #e5e7eb;">Filter</th>
                <th style="padding: 8px; text-align: center; border-bottom: 2px solid #e5e7eb;">Sort</th>
                <th style="padding: 8px; text-align: left; border-bottom: 2px solid #e5e7eb;">Item Place</th>
                <th style="padding: 8px; text-align: left; border-bottom: 2px solid #e5e7eb;">Special Role</th>
                <th style="padding: 8px; text-align: center; border-bottom: 2px solid #e5e7eb;">Actions</th>
              </tr>
            </thead>
            <tbody id="columnsTableBody">
              <!-- Populated dynamically -->
            </tbody>
          </table>
        </div>
        <div class="modal-footer">
          <button id="addColumnBtn" class="btn-primary">+ Add Column</button>
          <button id="manageColsCancelBtn" class="btn-secondary">Close</button>
        </div>
      </div>
    </div>

    <!-- Column Editor Modal -->
    <div id="columnEditorModal" class="modal">
      <div class="modal-box">
        <div class="modal-header">
          <h2 id="columnEditorTitle">Edit Column</h2>
          <button class="modal-close-x" onclick="closeColumnEditor()">‚úï</button>
        </div>
        <div class="modal-body">
          <label>Column Name</label>
          <input type="text" id="editColName" placeholder="e.g., Price">

          <label>Display Name</label>
          <input type="text" id="editColDisplayName" placeholder="e.g., Item Price">

          <label>Type</label>
          <select id="editColType">
            <option value="text">Text</option>
            <option value="number">Number</option>
            <option value="date">Date</option>
            <option value="image">Image</option>
            <option value="url">URL</option>
          </select>

          <label class="checkbox-label">
            <input type="checkbox" id="editColShowInFilter">
            Show in Filter
          </label>

          <label class="checkbox-label">
            <input type="checkbox" id="editColShowInSort">
            Show in Sort
          </label>

          <label>Item Place</label>
          <select id="editColItemPlace">
            <option value="Primary Identifier">Primary Identifier</option>
            <option value="Main Image">Main Image</option>
            <option value="SubId1">SubId1</option>
            <option value="SubId2">SubId2</option>
            <option value="Top Corner">Top Corner</option>
            <option value="Long text Up">Long text Up</option>
            <option value="Detail Left">Detail Left</option>
            <option value="Detail Right">Detail Right</option>
            <option value="Long text Down">Long text Down</option>
            <option value="Bottom">Bottom</option>
            <option value="">None</option>
          </select>

          <label>Special Role</label>
          <select id="editColSpecialRole">
            <option value="">None</option>
            <option value="Auto-filled User Mail">Auto-filled User Mail</option>
            <option value="External Link">External Link</option>
            <option value="Formula (Read-only)">Formula (Read-only)</option>
          </select>
        </div>
        <div class="modal-footer">
          <button id="columnEditorCancelBtn" class="btn-secondary">Cancel</button>
          <button id="columnEditorSaveBtn" class="btn-primary">Save</button>
        </div>
      </div>
    </div>

    <!-- Toast notification container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Fullscreen image viewer -->
    <div id="imgOverlay">
      <div id="imgOverlayInner">
        <img id="imgOverlayImg" alt="Full size">
        <button id="imgOverlayClose">‚úï</button>
      </div>
    </div>

    <script>
      // ==================== TOAST NOTIFICATION SYSTEM ====================
      
      function showToast(message, type = 'info') {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = 'toast ' + type;
        
        let icon = '‚ÑπÔ∏è';
        if (type === 'success') icon = '‚úì';
        if (type === 'error') icon = '‚úï';
        if (type === 'warning') icon = '‚ö†';
        
        toast.innerHTML = `
          <div class="toast-icon">${icon}</div>
          <div class="toast-content">${message}</div>
          <button class="toast-close">√ó</button>
        `;
        
        container.appendChild(toast);
        
        // Close button
        const closeBtn = toast.querySelector('.toast-close');
        closeBtn.onclick = () => removeToast(toast);
        
        // Auto-remove after 4 seconds
        setTimeout(() => {
          if (toast.parentElement) {
            removeToast(toast);
          }
        }, 4000);
      }
      
      function removeToast(toast) {
        toast.classList.add('hiding');
        setTimeout(() => {
          if (toast.parentElement) {
            toast.parentElement.removeChild(toast);
          }
        }, 300);
      }

      // ==================== AUTHENTICATION & SESSION MANAGEMENT ====================

      // Session storage keys
      const SESSION_TOKEN_KEY = 'catalogueSessionToken';
      const SESSION_USER_KEY = 'catalogueSessionUser';
      const SESSION_EMAIL_KEY = 'catalogueLoginEmail';

      // Get session token from localStorage
      function getSessionToken() {
        return localStorage.getItem(SESSION_TOKEN_KEY);
      }

      // Save session token and user to localStorage
      function saveSession(token, user) {
        localStorage.setItem(SESSION_TOKEN_KEY, token);
        localStorage.setItem(SESSION_USER_KEY, JSON.stringify(user));
      }

      // Get user from localStorage
      function getStoredUser() {
        const userStr = localStorage.getItem(SESSION_USER_KEY);
        return userStr ? JSON.parse(userStr) : null;
      }

      // Clear session
      function clearSession() {
        localStorage.removeItem(SESSION_TOKEN_KEY);
        localStorage.removeItem(SESSION_USER_KEY);
        localStorage.removeItem(SESSION_EMAIL_KEY);
      }

      // Show login screen
      function showLoginScreen() {
        document.getElementById('loginScreen').classList.add('show');
        document.querySelector('.shell').style.display = 'none';
      }

      // Hide login screen
      function hideLoginScreen() {
        document.getElementById('loginScreen').classList.remove('show');
        document.querySelector('.shell').style.display = 'block';
      }

      // Show login message
      function showLoginMessage(step, message, type) {
        const messageEl = document.getElementById('loginMessage' + step);
        messageEl.textContent = message;
        messageEl.className = 'login-message ' + type;
        messageEl.style.display = 'block';
      }

      // Hide login message
      function hideLoginMessage(step) {
        const messageEl = document.getElementById('loginMessage' + step);
        messageEl.style.display = 'none';
      }

      // Switch login steps
      function switchLoginStep(toStep) {
        document.getElementById('loginStepEmail').classList.remove('active');
        document.getElementById('loginStepCode').classList.remove('active');
        document.getElementById('loginStep' + toStep).classList.add('active');
      }

      // Request OTP code
      function requestOTP() {
        const email = document.getElementById('loginEmailInput').value.trim();

        if (!email) {
          showLoginMessage(1, 'Please enter your email address.', 'error');
          return;
        }

        const btn = document.getElementById('loginSendCodeBtn');
        btn.disabled = true;
        btn.innerHTML = '<span class="login-loading"></span>Sending code...';
        hideLoginMessage(1);

        // Store email for code verification step
        localStorage.setItem(SESSION_EMAIL_KEY, email);

        google.script.run
          .withSuccessHandler(function(result) {
            btn.disabled = false;
            btn.innerHTML = 'Send Verification Code';

            if (result.success) {
              showLoginMessage(1, result.message, 'success');
              setTimeout(() => {
                switchLoginStep('Code');
                hideLoginMessage(1);
              }, 1500);
            } else {
              showLoginMessage(1, result.message, 'error');
            }
          })
          .withFailureHandler(function(error) {
            btn.disabled = false;
            btn.innerHTML = 'Send Verification Code';
            showLoginMessage(1, 'Error: ' + error.message, 'error');
          })
          .requestOTP(email);
      }

      // Verify OTP code
      function verifyOTP() {
        const email = localStorage.getItem(SESSION_EMAIL_KEY);
        const code = document.getElementById('loginCodeInput').value.trim();

        if (!code) {
          showLoginMessage(2, 'Please enter the verification code.', 'error');
          return;
        }

        if (!email) {
          showLoginMessage(2, 'Session expired. Please start over.', 'error');
          setTimeout(() => {
            switchLoginStep('Email');
            hideLoginMessage(2);
          }, 2000);
          return;
        }

        const btn = document.getElementById('loginVerifyBtn');
        btn.disabled = true;
        btn.innerHTML = '<span class="login-loading"></span>Verifying...';
        hideLoginMessage(2);

        google.script.run
          .withSuccessHandler(function(result) {
            btn.disabled = false;
            btn.innerHTML = 'Verify & Sign In';

            if (result.success) {
              // Save session
              saveSession(result.token, result.user);

              showLoginMessage(2, result.message, 'success');

              // Load the app with authentication (without full page reload)
              setTimeout(() => {
                hideLoginScreen();
                init(); // Reinitialize the app
              }, 800);
            } else {
              showLoginMessage(2, result.message, 'error');
            }
          })
          .withFailureHandler(function(error) {
            btn.disabled = false;
            btn.innerHTML = 'Verify & Sign In';
            showLoginMessage(2, 'Error: ' + error.message, 'error');
          })
          .verifyOTP(email, code);
      }

      // Logout function
      function logout() {
        const token = getSessionToken();

        if (token) {
          google.script.run
            .withSuccessHandler(function(result) {
              clearSession();
              location.reload();
            })
            .withFailureHandler(function(error) {
              clearSession();
              location.reload();
            })
            .logout(token);
        } else {
          clearSession();
          location.reload();
        }
      }

      // Back to email step
      function backToEmailStep() {
        switchLoginStep('Email');
        hideLoginMessage(2);
        document.getElementById('loginCodeInput').value = '';
      }

      // ==================== CUSTOM CONFIRM DIALOG ====================

      function showConfirm(title, message, onConfirm) {
        const overlay = document.getElementById('confirmOverlay');
        const titleEl = document.getElementById('confirmTitle');
        const messageEl = document.getElementById('confirmMessage');
        const cancelBtn = document.getElementById('confirmCancel');
        const okBtn = document.getElementById('confirmOk');

        titleEl.textContent = title;
        messageEl.textContent = message;
        overlay.classList.add('show');

        // Remove old listeners
        const newCancelBtn = cancelBtn.cloneNode(true);
        const newOkBtn = okBtn.cloneNode(true);
        cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
        okBtn.parentNode.replaceChild(newOkBtn, okBtn);

        // Add new listeners
        newCancelBtn.onclick = () => {
          overlay.classList.remove('show');
        };

        newOkBtn.onclick = () => {
          overlay.classList.remove('show');
          if (onConfirm) onConfirm();
        };

        // Close on overlay click
        overlay.onclick = (e) => {
          if (e.target === overlay) {
            overlay.classList.remove('show');
          }
        };
      }

      // ==================== CUSTOM PROMPT DIALOG ====================

      function showPrompt(title, message, defaultValue, onConfirm) {
        const overlay = document.getElementById('promptOverlay');
        const titleEl = document.getElementById('promptTitle');
        const messageEl = document.getElementById('promptMessage');
        const inputEl = document.getElementById('promptInput');
        const cancelBtn = document.getElementById('promptCancel');
        const okBtn = document.getElementById('promptOk');

        titleEl.textContent = title;
        messageEl.textContent = message;
        inputEl.value = defaultValue || '';
        overlay.classList.add('show');

        // Focus input
        setTimeout(() => inputEl.focus(), 100);

        // Remove old listeners
        const newCancelBtn = cancelBtn.cloneNode(true);
        const newOkBtn = okBtn.cloneNode(true);
        cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
        okBtn.parentNode.replaceChild(newOkBtn, okBtn);

        const handleConfirm = () => {
          const value = inputEl.value.trim();
          if (value) {
            overlay.classList.remove('show');
            if (onConfirm) onConfirm(value);
          }
        };

        // Add new listeners
        newCancelBtn.onclick = () => {
          overlay.classList.remove('show');
        };

        newOkBtn.onclick = handleConfirm;

        // Submit on Enter key
        inputEl.onkeypress = (e) => {
          if (e.key === 'Enter') {
            handleConfirm();
          }
        };

        // Close on overlay click
        overlay.onclick = (e) => {
          if (e.target === overlay) {
            overlay.classList.remove('show');
          }
        };
      }

      // ==================== INDEXEDDB CACHE MANAGER ====================
      class ImageCacheDB {
        constructor() {
          this.dbName = 'CatalogueImageCache';
          this.storeName = 'images';
          this.version = 1;
          this.db = null;
        }

        async init() {
          return new Promise((resolve, reject) => {
            const request = indexedDB.open(this.dbName, this.version);
            
            request.onerror = () => reject(request.error);
            request.onsuccess = () => {
              this.db = request.result;
              resolve();
            };
            
            request.onupgradeneeded = (event) => {
              const db = event.target.result;
              if (!db.objectStoreNames.contains(this.storeName)) {
                db.createObjectStore(this.storeName, { keyPath: 'fileId' });
              }
            };
          });
        }

        async get(fileId) {
          if (!this.db) await this.init();
          
          return new Promise((resolve, reject) => {
            const transaction = this.db.transaction([this.storeName], 'readonly');
            const store = transaction.objectStore(this.storeName);
            const request = store.get(fileId);
            
            request.onsuccess = () => resolve(request.result);
            request.onerror = () => reject(request.error);
          });
        }

        async set(fileId, fullDataUrl, thumbnailDataUrl) {
          if (!this.db) await this.init();
          
          return new Promise((resolve, reject) => {
            const transaction = this.db.transaction([this.storeName], 'readwrite');
            const store = transaction.objectStore(this.storeName);
            const data = {
              fileId: fileId,
              full: fullDataUrl,
              thumbnail: thumbnailDataUrl,
              timestamp: Date.now()
            };
            const request = store.put(data);
            
            request.onsuccess = () => resolve();
            request.onerror = () => reject(request.error);
          });
        }

        async clear() {
          if (!this.db) await this.init();
          
          return new Promise((resolve, reject) => {
            const transaction = this.db.transaction([this.storeName], 'readwrite');
            const store = transaction.objectStore(this.storeName);
            const request = store.clear();
            
            request.onsuccess = () => resolve();
            request.onerror = () => reject(request.error);
          });
        }
      }

      // Initialize IndexedDB cache
      const imageCacheDB = new ImageCacheDB();
      
      // Memory cache for current session (faster than IndexedDB lookup)
      const memoryCache = new Map();

      // ==================== LAZY LOADING WITH INTERSECTION OBSERVER ====================
      let imageObserver = null;

      function setupLazyLoading() {
        if ('IntersectionObserver' in window) {
          imageObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
              if (entry.isIntersecting) {
                const wrapper = entry.target;
                const fileId = wrapper.dataset.fileId;
                const rawUrl = wrapper.dataset.rawUrl;
                
                if (fileId) {
                  loadImageViaProxy(fileId, wrapper);
                } else if (rawUrl) {
                  loadDirectImage(rawUrl, wrapper);
                }
                
                imageObserver.unobserve(wrapper);
              }
            });
          }, {
            rootMargin: '50px' // Start loading 50px before image enters viewport
          });
        }
      }

      // -------------------- State --------------------
      let allItems = [];
      let headers = [];
      let user = null;
      let settings = null;
      let columnConfig = [];

      // Dynamic column references (populated from columnConfig)
      let nameColumn = null;
      let descriptionColumn = null;
      let imageColumn = null;
      let categoryColumn = null;
      let placeColumn = null;
      let dateColumn = null;
      let externalLinkColumn = null;
      let addedByColumn = null;

      // Filter columns (columns with showInFilter = true)
      let filterColumns = [];
      let filterValues = {}; // { columnName: [selectedValue1, selectedValue2, ...] }

      let sortField = "none";
      let sortOrder = "asc";

      let editingItemName = null;
      let imageProxyBaseUrl = "";

      // -------------------- Helpers --------------------

      function formatDate(dateValue) {
        if (!dateValue) return "";
        try {
          // If it's a string in YYYY-MM-DD format, parse it manually to avoid timezone issues
          if (typeof dateValue === 'string' && dateValue.match(/^\d{4}-\d{2}-\d{2}/)) {
            const parts = dateValue.split('-');
            const year = parts[0];
            const month = parts[1];
            const day = parts[2].substring(0, 2); // Handle if there's time component
            return `${day}/${month}/${year}`;
          }

          const date = new Date(dateValue);
          if (isNaN(date.getTime())) return String(dateValue);

          const year = date.getFullYear();
          const month = String(date.getMonth() + 1).padStart(2, '0');
          const day = String(date.getDate()).padStart(2, '0');
          return `${day}/${month}/${year}`;
        } catch (e) {
          return String(dateValue);
        }
      }

      function formatDateForInput(dateValue) {
        if (!dateValue) return "";
        try {
          // If already in YYYY-MM-DD format, return as-is
          if (typeof dateValue === 'string' && dateValue.match(/^\d{4}-\d{2}-\d{2}$/)) {
            return dateValue;
          }

          const date = new Date(dateValue);
          if (isNaN(date.getTime())) return String(dateValue);

          const year = date.getFullYear();
          const month = String(date.getMonth() + 1).padStart(2, '0');
          const day = String(date.getDate()).padStart(2, '0');
          return `${year}-${month}-${day}`;
        } catch (e) {
          return String(dateValue);
        }
      }

      function loadColumnConfig() {
        // Reset column references
        nameColumn = null;
        descriptionColumn = null;
        imageColumn = null;
        categoryColumn = null;
        placeColumn = null;
        dateColumn = null;
        externalLinkColumn = null;
        addedByColumn = null;
        filterColumns = [];

        // Build column references from config
        for (let i = 0; i < columnConfig.length; i++) {
          const config = columnConfig[i];
          const place = config.itemPlace;
          const role = config.specialRole;

          if (place === "name") {
            nameColumn = config;
          } else if (place === "image") {
            imageColumn = config;
          } else if (place === "category") {
            categoryColumn = config;
          } else if (place === "place") {
            placeColumn = config;
          }

          // Check special roles
          if (role === "addedby") {
            addedByColumn = config;
          }

          // Find date column by type
          if (config.type === "date" && !dateColumn) {
            dateColumn = config;
          }

          // Build filter columns list
          if (config.showInFilter) {
            filterColumns.push(config);
            if (!filterValues[config.columnName]) {
              filterValues[config.columnName] = [];
            }
          }
        }

        // Set defaults if not found
        if (!nameColumn && headers.length > 0) {
          nameColumn = { columnName: headers[0], displayName: headers[0], specialRole: "name" };
        }
      }

      function computeUniqueValues() {
        // Compute unique values for all filter columns
        for (let i = 0; i < filterColumns.length; i++) {
          const config = filterColumns[i];
          const valueSet = new Set();

          for (let j = 0; j < allItems.length; j++) {
            const item = allItems[j];
            const value = item[config.columnName];
            if (value != null && String(value).trim() !== "") {
              valueSet.add(String(value).trim());
            }
          }

          config.uniqueValues = Array.from(valueSet).sort();
        }
      }

      // Check if a column has any non-empty values
      function isColumnUsed(columnName) {
        if (!columnName) return false;
        for (let i = 0; i < allItems.length; i++) {
          const val = allItems[i][columnName];
          if (val != null && String(val).trim() !== "") {
            return true;
          }
        }
        return false;
      }

      // --- DRIVE IMAGE HELPERS WITH PROGRESSIVE LOADING + INDEXEDDB + LAZY LOADING ---

      function extractDriveFileId(url) {
        if (!url) return null;
        url = String(url).trim();

        let m = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
        if (m && m[1]) return m[1];

        m = url.match(/[?&]id=([a-zA-Z0-9_-]+)/);
        if (m && m[1]) return m[1];

        if (/^[a-zA-Z0-9_-]{20,}$/.test(url)) return url;

        return null;
      }

      // Generate tiny thumbnail from full image (for progressive loading)
      function generateThumbnail(fullDataUrl) {
        return new Promise((resolve) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // Create 10x10 thumbnail (super tiny for fast loading)
            canvas.width = 10;
            canvas.height = 10;
            
            ctx.drawImage(img, 0, 0, 10, 10);
            resolve(canvas.toDataURL('image/jpeg', 0.5));
          };
          img.onerror = () => resolve(null);
          img.src = fullDataUrl;
        });
      }

      // OPTIMIZED: Check memory ‚Üí IndexedDB ‚Üí Network
      async function loadImageViaProxy(fileId, wrapper) {
        if (!fileId || !wrapper) return;

        try {
          // 1. Check memory cache (instant)
          if (memoryCache.has(fileId)) {
            const cached = memoryCache.get(fileId);
            applyProgressiveImage(wrapper, cached.thumbnail, cached.full);
            return;
          }

          // 2. Check IndexedDB (fast, persists across sessions)
          const dbCached = await imageCacheDB.get(fileId);
          if (dbCached && dbCached.full) {
            memoryCache.set(fileId, {
              full: dbCached.full,
              thumbnail: dbCached.thumbnail
            });
            applyProgressiveImage(wrapper, dbCached.thumbnail, dbCached.full);
            return;
          }

          // 3. Fetch from network (slow, only if not cached)
          const base = imageProxyBaseUrl || "";
          const url = base.replace(/\/$/, "") + "?img=" + encodeURIComponent(fileId);

          console.log('Loading image from:', url);

          const response = await fetch(url);
          const json = await response.json();

          if (!json.ok) {
            console.error('Image fetch failed:', json.error || 'Unknown error', 'FileID:', fileId);
            wrapper.innerHTML = '<div style="width:100%;height:100%;background:repeating-linear-gradient(45deg,#e5e7eb,#e5e7eb 6px,#f3f4f6 6px,#f3f4f6 12px);"></div>';
            return;
          }

          const fullDataUrl = "data:" + json.mime + ";base64," + json.data;
          
          // Generate thumbnail for progressive loading
          const thumbnailDataUrl = await generateThumbnail(fullDataUrl);

          // Store in both caches
          memoryCache.set(fileId, {
            full: fullDataUrl,
            thumbnail: thumbnailDataUrl
          });
          
          await imageCacheDB.set(fileId, fullDataUrl, thumbnailDataUrl);

          applyProgressiveImage(wrapper, thumbnailDataUrl, fullDataUrl);

        } catch (err) {
          console.error("Image load error:", err);
          wrapper.innerHTML = '<div style="width:100%;height:100%;background:repeating-linear-gradient(45deg,#e5e7eb,#e5e7eb 6px,#f3f4f6 6px,#f3f4f6 12px);"></div>';
        }
      }

      // Apply progressive loading effect (blur thumbnail ‚Üí sharp full image)
      function applyProgressiveImage(wrapper, thumbnailUrl, fullUrl) {
        wrapper.innerHTML = '';

        // Show blurred thumbnail first (if available)
        if (thumbnailUrl) {
          const placeholder = document.createElement('img');
          placeholder.className = 'card-img placeholder';
          placeholder.src = thumbnailUrl;
          wrapper.appendChild(placeholder);
        }

        // Load full image
        const fullImg = document.createElement('img');
        fullImg.className = 'card-img full';
        fullImg.onload = () => {
          fullImg.classList.add('loaded');
        };
        fullImg.src = fullUrl;
        wrapper.appendChild(fullImg);
      }

      // Load regular HTTPS images (non-Drive)
      function loadDirectImage(url, wrapper) {
        wrapper.innerHTML = '';
        const img = document.createElement('img');
        img.className = 'card-img full loaded';
        img.src = url;
        img.loading = 'lazy';
        wrapper.appendChild(img);
      }

      // -------------------- Rendering --------------------

      function updateHeaderUI() {
        document.getElementById("appName").textContent =
          (settings && settings.appName) || "App";

        document.getElementById("catalogName").textContent =
          (settings && settings.catalogName) || "Catalogue";

        document.getElementById("userEmail").textContent =
          (user && user.email) || "";
        document.getElementById("userProfilePill").textContent =
          (user && user.profile) || "";

        document.title = (settings && settings.appName) || "Catalogue";

        // Hide user info and logout button in public mode
        const isPublicMode = settings && settings.appMode === "Public all in Viewer";
        const userInfoBlock = document.getElementById("userInfoBlock");
        if (userInfoBlock) {
          userInfoBlock.style.display = isPublicMode ? "none" : "flex";
        }
      }

      function canEditItem(item) {
        if (!user) return false;
        if (user.profile === "Creator") return true;
        if (user.profile === "Editor") {
          return item["Added By"] === user.email;
        }
        return false;
      }

      function canDeleteItem(item) {
        return canEditItem(item);
      }

      function applyRoleVisibility() {
        if (!user) return;

        const addBtn = document.getElementById("addBtn");
        const columnsBtn = document.getElementById("columnsBtn");
        const editCatalogBtn = document.getElementById("editCatalogBtn");
        const sheetLinkBtn = document.getElementById("sheetLinkBtn");

        if (user.profile === "Viewer") {
          addBtn.style.display = "none";
          columnsBtn.style.display = "none";
          editCatalogBtn.style.display = "none";
          sheetLinkBtn.style.display = "none";
        } else if (user.profile === "Editor") {
          addBtn.style.display = "inline-flex";
          columnsBtn.style.display = "none";
          editCatalogBtn.style.display = "none";
          sheetLinkBtn.style.display = "none";
        } else if (user.profile === "Creator") {
          addBtn.style.display = "inline-flex";
          columnsBtn.style.display = "inline-flex";
          editCatalogBtn.style.display = "inline-block";
          sheetLinkBtn.style.display = "inline-flex";
        }

        // Hide Filter button if no filter columns configured or used
        const filterBtn = document.getElementById("filterBtn");
        const hasFilterData = filterColumns.length > 0 && filterColumns.some(col =>
          col.uniqueValues && col.uniqueValues.length > 0
        );

        if (!hasFilterData) {
          filterBtn.style.display = "none";
        } else {
          filterBtn.style.display = "inline-flex";
        }
      }

      function updateChipsUI() {
        // Count total filters selected
        let totalFilters = 0;
        for (const columnName in filterValues) {
          totalFilters += filterValues[columnName].length;
        }

        const badge = document.getElementById("filterBadge");
        if (totalFilters > 0) {
          badge.textContent = totalFilters;
          badge.style.display = "inline-flex";
        } else {
          badge.style.display = "none";
        }

        // Update sort label
        const sortLabel = document.getElementById("sortLabel");
        if (sortField === "none") {
          sortLabel.textContent = "None";
        } else {
          // Find display name for sort field
          let displayName = sortField;
          for (let i = 0; i < columnConfig.length; i++) {
            if (columnConfig[i].columnName === sortField) {
              displayName = columnConfig[i].displayName || sortField;
              break;
            }
          }
          const orderText = sortOrder === "asc" ? "‚Üë" : "‚Üì";
          sortLabel.textContent = displayName + " " + orderText;
        }
      }

      function applyFiltersAndSorting() {
        let items = allItems.slice();

        // Apply all filters (items must match ALL selected filters)
        for (const columnName in filterValues) {
          const selected = filterValues[columnName];
          if (selected && selected.length > 0) {
            items = items.filter(function (it) {
              const itemValue = String(it[columnName] || "");
              return selected.indexOf(itemValue) !== -1;
            });
          }
        }

        // Sorting
        if (sortField !== "none") {
          // Check if this is a date column
          let isDateColumn = false;
          for (let i = 0; i < columnConfig.length; i++) {
            if (columnConfig[i].columnName === sortField && columnConfig[i].type === "date") {
              isDateColumn = true;
              break;
            }
          }

          items.sort(function (a, b) {
            let av = a[sortField];
            let bv = b[sortField];

            // Date sorting: oldest -> newest for asc
            if (isDateColumn || (dateColumn && sortField === dateColumn.columnName)) {
              let ad = av ? new Date(av) : null;
              let bd = bv ? new Date(bv) : null;
              if (!ad && !bd) return 0;
              if (!ad) return 1;
              if (!bd) return -1;
              return sortOrder === "asc" ? ad - bd : bd - ad;
            }

            // string compare
            av = av == null ? "" : String(av).toLowerCase();
            bv = bv == null ? "" : String(bv).toLowerCase();
            if (av < bv) return sortOrder === "asc" ? -1 : 1;
            if (av > bv) return sortOrder === "asc" ? 1 : -1;
            return 0;
          });
        }

        renderList(items);
      }

      function renderList(items) {
        const grid = document.getElementById("gridView");
        const det = document.getElementById("detailView");
        det.style.display = "none";
        grid.innerHTML = "";

        if (!items.length) {
          grid.innerHTML =
            "<p style='color:#6b7280;font-size:13px;'>No items for this selection.</p>";
          return;
        }

        for (let i = 0; i < items.length; i++) {
          const item = items[i];
          const card = document.createElement("div");
          card.className = "card";

          // Create image wrapper for lazy loading
          const imgWrapper = document.createElement("div");
          imgWrapper.className = "card-img-wrapper";

          if (imageColumn && item[imageColumn.columnName]) {
            const rawUrl = item[imageColumn.columnName];
            const fileId = extractDriveFileId(rawUrl);

            if (fileId) {
              // LAZY LOADING: Store fileId and observe
              imgWrapper.dataset.fileId = fileId;
              if (imageObserver) {
                imageObserver.observe(imgWrapper);
              } else {
                // Fallback if IntersectionObserver not supported
                loadImageViaProxy(fileId, imgWrapper);
              }
            } else if (rawUrl) {
              // Direct HTTPS image
              imgWrapper.dataset.rawUrl = rawUrl;
              if (imageObserver) {
                imageObserver.observe(imgWrapper);
              } else {
                loadDirectImage(rawUrl, imgWrapper);
              }
            } else {
              imgWrapper.innerHTML = '<div style="width:100%;height:100%;background:repeating-linear-gradient(45deg,#e5e7eb,#e5e7eb 6px,#f3f4f6 6px,#f3f4f6 12px);"></div>';
            }
          } else {
            imgWrapper.innerHTML = '<div style="width:100%;height:100%;background:repeating-linear-gradient(45deg,#e5e7eb,#e5e7eb 6px,#f3f4f6 6px,#f3f4f6 12px);"></div>';
          }

          card.appendChild(imgWrapper);

          const body = document.createElement("div");
          body.className = "card-body";

          const nameEl = document.createElement("div");
          nameEl.className = "card-name";
          nameEl.textContent = nameColumn ? (item[nameColumn.columnName] || "(no name)") : "(no name)";
          body.appendChild(nameEl);

          const sub = document.createElement("div");
          sub.className = "card-sub";
          const cat = categoryColumn ? (item[categoryColumn.columnName] || "") : "";
          const place = placeColumn ? (item[placeColumn.columnName] || "") : "";
          sub.textContent = [cat, place].filter(Boolean).join(" ‚Ä¢ ");
          body.appendChild(sub);

          card.appendChild(body);

          card.onclick = (function (it) {
            return function () {
              showDetails(it);
            };
          })(item);

          grid.appendChild(card);
        }
      }

      function showDetails(item) {
        const det = document.getElementById("detailView");
        const grid = document.getElementById("gridView");
        det.style.display = "block";
        grid.innerHTML = "";

        // Show back button, hide filter and sort
        document.getElementById("backToListBtn").style.display = "inline-flex";
        document.getElementById("filterWrapper").style.display = "none";
        document.getElementById("sortWrapper").style.display = "none";

        let html =
          '<div class="detail-layout">' +
          '<div id="detailImgContainer">';

        if (imageColumn && item[imageColumn.columnName]) {
          html += '<div class="detail-img-wrapper" id="detailImgWrapper"></div>';
        } else {
          html += '<div class="detail-img-wrapper"></div>';
        }

        html +=
          "</div>" +
          "<div>" +
          '<div class="detail-title-row">' +
          '<div class="detail-name">' +
          (nameColumn ? (item[nameColumn.columnName] || "") : "") +
          "</div>" +
          "</div>";

        // Add SubID1 and SubID2 under the Primary Identifier (like in card view)
        const subBits = [];
        if (categoryColumn && item[categoryColumn.columnName]) subBits.push(item[categoryColumn.columnName]);
        if (placeColumn && item[placeColumn.columnName]) subBits.push(item[placeColumn.columnName]);

        if (subBits.length > 0) {
          html += '<div class="detail-subtitle">' +
            subBits.join(" ‚Ä¢ ") +
            '</div>';
        }

        // Top Corner fields - collect all values with same styling as SubId
        const topCornerBits = [];
        for (let i = 0; i < columnConfig.length; i++) {
          const config = columnConfig[i];
          if (config.itemPlace !== "topcorner") continue;

          const val = item[config.columnName];
          if (val != null && String(val).trim() !== "") {
            const displayVal = config.type === "date" ? formatDate(val) : val;
            topCornerBits.push(displayVal);
          }
        }

        if (topCornerBits.length > 0) {
          html += '<div class="detail-topcorner" style="position: absolute; top: 4px; right: 16px;">' +
            topCornerBits.join(" ‚Ä¢ ") +
            '</div>';
        }

        // Long text Up fields (before two-column grid)
        for (let i = 0; i < columnConfig.length; i++) {
          const config = columnConfig[i];
          if (config.itemPlace !== "longtextup") continue;

          const val = item[config.columnName];
          if (val != null && String(val).trim() !== "") {
            const displayVal = config.type === "date" ? formatDate(val) : val;
            html +=
              '<div class="detail-field" style="margin-top: 16px;"><span class="detail-label">' +
              (config.displayName || config.columnName) +
              ":</span> " +
              displayVal +
              "</div>";
          }
        }

        // Create two-column layout for detail fields
        html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 16px;">';

        // Left column
        html += '<div>';
        for (let i = 0; i < columnConfig.length; i++) {
          const config = columnConfig[i];
          if (config.itemPlace !== "detailleft") continue;

          const val = item[config.columnName];
          if (val != null && String(val).trim() !== "") {
            // Check if it's a URL type or external link
            if (config.type === "url" || config.specialRole === "externallink") {
              const linkLabel = config.displayName || config.columnName;
              html +=
                '<div class="detail-field">' +
                '<a href="' +
                val +
                '" target="_blank" class="link-pill" rel="noopener noreferrer">' +
                "üîó " + linkLabel +
                "</a>" +
                "</div>";
            } else {
              const displayVal = config.type === "date" ? formatDate(val) : val;
              html +=
                '<div class="detail-field"><span class="detail-label">' +
                (config.displayName || config.columnName) +
                ":</span> " +
                displayVal +
                "</div>";
            }
          }
        }
        html += '</div>';

        // Right column
        html += '<div>';
        for (let i = 0; i < columnConfig.length; i++) {
          const config = columnConfig[i];
          if (config.itemPlace !== "detailright") continue;

          const val = item[config.columnName];
          if (val != null && String(val).trim() !== "") {
            // Check if it's a URL type or external link
            if (config.type === "url" || config.specialRole === "externallink") {
              const linkLabel = config.displayName || config.columnName;
              html +=
                '<div class="detail-field">' +
                '<a href="' +
                val +
                '" target="_blank" class="link-pill" rel="noopener noreferrer">' +
                "üîó " + linkLabel +
                "</a>" +
                "</div>";
            } else {
              const displayVal = config.type === "date" ? formatDate(val) : val;
              html +=
                '<div class="detail-field"><span class="detail-label">' +
                (config.displayName || config.columnName) +
                ":</span> " +
                displayVal +
                "</div>";
            }
          }
        }
        html += '</div>';

        html += '</div>'; // Close grid

        // Long text Down fields (after two-column grid)
        for (let i = 0; i < columnConfig.length; i++) {
          const config = columnConfig[i];
          if (config.itemPlace !== "longtextdown") continue;

          const val = item[config.columnName];
          if (val != null && String(val).trim() !== "") {
            const displayVal = config.type === "date" ? formatDate(val) : val;
            html +=
              '<div class="detail-field" style="margin-top: 16px;"><span class="detail-label">' +
              (config.displayName || config.columnName) +
              ":</span> " +
              displayVal +
              "</div>";
          }
        }

        // External Link fields that don't have an itemPlace (special role only)
        for (let i = 0; i < columnConfig.length; i++) {
          const config = columnConfig[i];
          if (config.specialRole !== "externallink") continue;
          // Skip if it already has an itemPlace and was rendered above
          if (config.itemPlace && config.itemPlace !== "") continue;

          const url = item[config.columnName];
          if (url && String(url).trim() !== "") {
            const linkLabel = config.displayName || config.columnName;
            html +=
              '<div class="detail-field" style="margin-top: 12px;">' +
              '<a href="' +
              url +
              '" target="_blank" class="link-pill" rel="noopener noreferrer">' +
              "üîó " + linkLabel +
              "</a>" +
              "</div>";
          }
        }

        // Bottom fields (like "Added by" placement)
        for (let i = 0; i < columnConfig.length; i++) {
          const config = columnConfig[i];
          if (config.itemPlace !== "bottom") continue;

          const val = item[config.columnName];
          if (val != null && String(val).trim() !== "") {
            const displayVal = config.type === "date" ? formatDate(val) : val;
            html +=
              '<div class="detail-field" style="margin-top:10px;font-size:11px;color:#9ca3af;">' +
              displayVal +
              "</div>";
          }
        }

        if (user && user.profile !== "Viewer") {
          const editable = canEditItem(item);
          const deletable = canDeleteItem(item);

          if (editable || deletable) {
            html += '<div class="detail-actions">';
            if (editable) {
              const itemName = nameColumn ? (item[nameColumn.columnName] || "") : "";
              html +=
                '<button class="btn-secondary" onclick="openEdit(\'' +
                itemName.replace(/'/g, "\\'") +
                "')\">‚úè Edit</button>";
            }
            if (deletable) {
              const itemName = nameColumn ? (item[nameColumn.columnName] || "") : "";
              html +=
                '<button class="btn-danger" onclick="confirmDelete(\'' +
                itemName.replace(/'/g, "\\'") +
                "')\">üóë Delete</button>";
            }
            html += "</div>";
          }
        }

        html += "</div></div>";
        det.innerHTML = html;

        // Load detail image with progressive loading
        const imgWrapper = document.getElementById("detailImgWrapper");
        if (imgWrapper && imageColumn && item[imageColumn.columnName]) {
          const rawUrl = item[imageColumn.columnName];
          const fileId = extractDriveFileId(rawUrl);

          if (fileId) {
            loadDetailImage(fileId, imgWrapper);
          } else if (rawUrl) {
            loadDetailImageDirect(rawUrl, imgWrapper);
          }
        }
      }

      // Load detail view image with progressive loading and fullscreen capability
      async function loadDetailImage(fileId, wrapper) {
        try {
          // Check caches
          if (memoryCache.has(fileId)) {
            const cached = memoryCache.get(fileId);
            applyDetailProgressiveImage(wrapper, cached.thumbnail, cached.full);
            return;
          }

          const dbCached = await imageCacheDB.get(fileId);
          if (dbCached && dbCached.full) {
            memoryCache.set(fileId, {
              full: dbCached.full,
              thumbnail: dbCached.thumbnail
            });
            applyDetailProgressiveImage(wrapper, dbCached.thumbnail, dbCached.full);
            return;
          }

          // If not cached, it should already be in memory from grid view
          // But fetch anyway as fallback
          const base = imageProxyBaseUrl || "";
          const url = base.replace(/\/$/, "") + "?img=" + encodeURIComponent(fileId);

          const response = await fetch(url);
          const json = await response.json();

          if (!json.ok) return;

          const fullDataUrl = "data:" + json.mime + ";base64," + json.data;
          const thumbnailDataUrl = await generateThumbnail(fullDataUrl);

          memoryCache.set(fileId, {
            full: fullDataUrl,
            thumbnail: thumbnailDataUrl
          });
          
          await imageCacheDB.set(fileId, fullDataUrl, thumbnailDataUrl);

          applyDetailProgressiveImage(wrapper, thumbnailDataUrl, fullDataUrl);

        } catch (err) {
          console.error("Detail image load error:", err);
        }
      }

      function applyDetailProgressiveImage(wrapper, thumbnailUrl, fullUrl) {
        wrapper.innerHTML = '';

        if (thumbnailUrl) {
          const placeholder = document.createElement('img');
          placeholder.className = 'detail-img placeholder';
          placeholder.src = thumbnailUrl;
          wrapper.appendChild(placeholder);
        }

        const fullImg = document.createElement('img');
        fullImg.className = 'detail-img full';
        fullImg.onload = () => {
          fullImg.classList.add('loaded');
          // Remove placeholder after full image loads
          setTimeout(() => {
            const placeholders = wrapper.querySelectorAll('.placeholder');
            placeholders.forEach(p => p.remove());
          }, 400);
        };
        fullImg.src = fullUrl;
        fullImg.style.cursor = 'zoom-in';
        fullImg.onclick = () => openImageFullscreen(fullUrl);
        wrapper.appendChild(fullImg);
      }

      function loadDetailImageDirect(url, wrapper) {
        wrapper.innerHTML = '';
        const img = document.createElement('img');
        img.className = 'detail-img full loaded';
        img.src = url;
        img.style.cursor = 'zoom-in';
        img.onclick = () => openImageFullscreen(url);
        wrapper.appendChild(img);
      }

      function backToList() {
        document.getElementById("detailView").style.display = "none";

        // Hide back button, show filter and sort
        document.getElementById("backToListBtn").style.display = "none";
        document.getElementById("filterWrapper").style.display = "inline-block";
        document.getElementById("sortWrapper").style.display = "inline-block";

        applyFiltersAndSorting();
      }

      // -------------------- Fullscreen viewer --------------------

      function openImageFullscreen(src) {
        const overlay = document.getElementById("imgOverlay");
        const img = document.getElementById("imgOverlayImg");
        if (!overlay || !img || !src) return;
        img.src = src;
        overlay.style.display = "flex";
      }

      function closeImageFullscreen() {
        const overlay = document.getElementById("imgOverlay");
        if (overlay) overlay.style.display = "none";
      }

      // -------------------- Filter & Sort Dropdowns --------------------

      function populateFilterDropdown() {
        const filterDropdown = document.getElementById("filterDropdown");
        filterDropdown.innerHTML = "";

        // Generate filter sections for each filter column
        for (let i = 0; i < filterColumns.length; i++) {
          const config = filterColumns[i];
          if (!config.uniqueValues || config.uniqueValues.length === 0) continue;

          // Create section
          const section = document.createElement("div");
          section.className = "dropdown-section";

          const title = document.createElement("div");
          title.className = "dropdown-section-title";
          title.textContent = config.displayName || config.columnName;
          section.appendChild(title);

          const listContainer = document.createElement("div");

          config.uniqueValues.forEach(value => {
            const item = document.createElement("div");
            item.className = "dropdown-item";

            const checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            checkbox.id = "filter_" + config.columnName + "_" + value.replace(/\s/g, '_');
            checkbox.value = value;

            const selected = filterValues[config.columnName] || [];
            checkbox.checked = selected.indexOf(value) !== -1;

            checkbox.onchange = (e) => {
              e.stopPropagation();
              if (!filterValues[config.columnName]) {
                filterValues[config.columnName] = [];
              }

              const idx = filterValues[config.columnName].indexOf(value);
              if (checkbox.checked) {
                // Add to selection if not already there
                if (idx === -1) {
                  filterValues[config.columnName].push(value);
                }
              } else {
                // Remove from selection
                if (idx !== -1) {
                  filterValues[config.columnName].splice(idx, 1);
                }
              }

              updateChipsUI();
              applyFiltersAndSorting();
            };

            const label = document.createElement("span");
            label.textContent = value;

            item.onclick = (e) => {
              if (e.target !== checkbox) {
                checkbox.checked = !checkbox.checked;
                checkbox.onchange(e);
              }
            };

            item.appendChild(checkbox);
            item.appendChild(label);
            listContainer.appendChild(item);
          });

          section.appendChild(listContainer);
          filterDropdown.appendChild(section);
        }

        // Add divider and clear button
        if (filterColumns.length > 0) {
          const divider = document.createElement("div");
          divider.className = "dropdown-divider";
          filterDropdown.appendChild(divider);

          const actions = document.createElement("div");
          actions.className = "dropdown-actions";

          const clearBtn = document.createElement("button");
          clearBtn.className = "dropdown-btn";
          clearBtn.textContent = "Clear Filters";
          clearBtn.onclick = () => {
            filterValues = {};
            for (let i = 0; i < filterColumns.length; i++) {
              filterValues[filterColumns[i].columnName] = [];
            }
            populateFilterDropdown();
            updateChipsUI();
            applyFiltersAndSorting();
          };

          actions.appendChild(clearBtn);
          filterDropdown.appendChild(actions);
        }
      }

      function populateSortDropdown() {
        const sortDropdown = document.getElementById("sortDropdown");
        const firstSection = sortDropdown.querySelector(".dropdown-section");

        // Rebuild sort options based on showInSort configuration
        firstSection.innerHTML = '<div class="dropdown-section-title">Sort by</div>';

        // Always include "No sorting"
        const noneItem = document.createElement("div");
        noneItem.className = "dropdown-item";
        noneItem.dataset.sort = "none";
        const noneRadio = document.createElement("input");
        noneRadio.type = "radio";
        noneRadio.name = "sortField";
        noneRadio.value = "none";
        noneRadio.checked = sortField === "none";
        const noneLabel = document.createElement("span");
        noneLabel.textContent = "No sorting";
        noneItem.appendChild(noneRadio);
        noneItem.appendChild(noneLabel);
        firstSection.appendChild(noneItem);

        // Add sort options for columns with showInSort = true
        for (let i = 0; i < columnConfig.length; i++) {
          const config = columnConfig[i];
          if (!config.showInSort) continue;

          // Check if column has any values
          if (!isColumnUsed(config.columnName)) continue;

          const item = document.createElement("div");
          item.className = "dropdown-item";
          item.dataset.sort = config.columnName;

          const radio = document.createElement("input");
          radio.type = "radio";
          radio.name = "sortField";
          radio.value = config.columnName;
          radio.checked = sortField === config.columnName;

          const label = document.createElement("span");
          label.textContent = config.displayName || config.columnName;

          item.appendChild(radio);
          item.appendChild(label);
          firstSection.appendChild(item);
        }

        // Re-attach event listeners for sort field
        firstSection.querySelectorAll('input[name="sortField"]').forEach(radio => {
          radio.onchange = function() {
            sortField = this.value;
            updateChipsUI();
            applyFiltersAndSorting();
          };
        });

        firstSection.querySelectorAll('.dropdown-item').forEach(item => {
          item.onclick = function(e) {
            if (e.target.tagName !== 'INPUT') {
              const radio = this.querySelector('input[type="radio"]');
              if (radio) {
                radio.checked = true;
                radio.onchange();
              }
            }
          };
        });

        // Re-attach event listeners for sort order
        const orderRadios = sortDropdown.querySelectorAll('input[name="sortOrder"]');
        orderRadios.forEach(radio => {
          radio.onchange = function() {
            sortOrder = this.value;
            updateChipsUI();
            applyFiltersAndSorting();
          };
        });

        const orderItems = sortDropdown.querySelectorAll('[data-order]');
        orderItems.forEach(item => {
          item.onclick = function(e) {
            if (e.target.tagName !== 'INPUT') {
              const radio = this.querySelector('input[type="radio"]');
              if (radio) {
                radio.checked = true;
                radio.onchange();
              }
            }
          };
        });
      }

      function toggleDropdown(dropdownId, buttonId) {
        const dropdown = document.getElementById(dropdownId);
        const isShowing = dropdown.classList.contains("show");
        
        // Close all dropdowns first
        document.querySelectorAll(".dropdown-menu").forEach(d => {
          d.classList.remove("show");
        });
        
        // Toggle current dropdown
        if (!isShowing) {
          dropdown.classList.add("show");
          
          // Populate filter dropdown when opened
          if (dropdownId === "filterDropdown") {
            populateFilterDropdown();
          }
          
          // Populate sort dropdown when opened
          if (dropdownId === "sortDropdown") {
            populateSortDropdown();
          }
        }
      }

      // Close dropdowns when clicking outside
      document.addEventListener("click", function(e) {
        if (!e.target.closest(".btn-toolbar") && !e.target.closest(".dropdown-menu")) {
          document.querySelectorAll(".dropdown-menu").forEach(d => {
            d.classList.remove("show");
          });
        }
      });



      // -------------------- Add / Edit / Delete Items --------------------

      function openAdd() {
        editingItemName = null;
        const modal = document.getElementById("editModal");
        const title = document.getElementById("editModalTitle");
        const body = document.getElementById("editModalBody");
        title.textContent = "Add item";
        body.innerHTML = "";

        // Show only columns that are not "addedby" or "formula" (read-only)
        for (let i = 0; i < columnConfig.length; i++) {
          const config = columnConfig[i];

          // Skip auto-filled and read-only columns
          if (config.specialRole === "addedby" || config.specialRole === "formula") {
            continue;
          }

          let val = "";
          // Pre-fill if single filter value selected
          if (filterValues[config.columnName] && filterValues[config.columnName].length === 1) {
            val = filterValues[config.columnName][0];
          }

          const displayName = config.displayName || config.columnName;
          const inputType = config.type === "date" ? "date" : "text";
          body.innerHTML +=
            "<label>" +
            displayName +
            "</label>" +
            '<input type="' + inputType + '" id="field_' +
            config.columnName +
            '" value="' +
            (val || "") +
            '" data-column="' +
            config.columnName +
            '" placeholder="' + (config.type === "date" ? "" : "Enter " + displayName.toLowerCase()) + '">';
        }

        modal.style.display = "flex";
        document.getElementById("editSaveBtn").onclick = saveAddOrEdit;
      }

      function openEdit(name) {
        editingItemName = name;
        const token = getSessionToken();

        // Open modal immediately with loading state
        const modal = document.getElementById("editModal");
        const title = document.getElementById("editModalTitle");
        const body = document.getElementById("editModalBody");
        title.textContent = "Edit item";
        body.innerHTML = '<div style="text-align: center; padding: 40px; color: #9ca3af;">Loading...</div>';
        modal.style.display = "flex";

        // Fetch data
        google.script.run
          .withSuccessHandler(function (item) {
            if (!item) {
              closeEditModal();
              showToast("Item not found.", "error");
              return;
            }

            body.innerHTML = "";

            // Show only columns that are not "addedby" or "formula" (read-only)
            for (let i = 0; i < columnConfig.length; i++) {
              const config = columnConfig[i];

              // Skip auto-filled and read-only columns
              if (config.specialRole === "addedby" || config.specialRole === "formula") {
                continue;
              }

              let val = item[config.columnName] || "";
              const displayName = config.displayName || config.columnName;
              const inputType = config.type === "date" ? "date" : "text";

              // Format date for input[type="date"] (YYYY-MM-DD)
              if (config.type === "date" && val) {
                val = formatDateForInput(val);
              }

              body.innerHTML +=
                "<label>" +
                displayName +
                "</label>" +
                '<input type="' + inputType + '" id="field_' +
                config.columnName +
                '" value="' +
                String(val).replace(/"/g, "&quot;") +
                '" data-column="' +
                config.columnName +
                '" placeholder="' + (config.type === "date" ? "" : "Enter " + displayName.toLowerCase()) + '">';
            }

            document.getElementById("editSaveBtn").onclick = saveAddOrEdit;
          })
          .withFailureHandler(function(error) {
            closeEditModal();
            showToast("Error: " + error.message, "error");
          })
          .getItemByName(name, token);
      }

      function closeEditModal() {
        document.getElementById("editModal").style.display = "none";
      }

      function saveAddOrEdit() {
        const obj = {};
        const token = getSessionToken();

        // Collect values from all field inputs
        for (let i = 0; i < columnConfig.length; i++) {
          const config = columnConfig[i];

          // Skip auto-filled and read-only columns
          if (config.specialRole === "addedby" || config.specialRole === "formula") {
            continue;
          }

          const el = document.getElementById("field_" + config.columnName);
          if (el) {
            obj[config.columnName] = el.value;
          }
        }

        if (!editingItemName) {
          // Adding new item
          google.script.run
            .withSuccessHandler(function (msg) {
              showToast(msg, "success");
              closeEditModal();
              google.script.run
                .withSuccessHandler(function (data) {
                  allItems = data || [];
                  computeUniqueValues();
                  applyFiltersAndSorting();
                })
                .getMainData();
            })
            .withFailureHandler(function(error) {
              showToast("Error: " + error.message, "error");
            })
            .addMainRow(obj, token);
        } else {
          // Editing existing item
          google.script.run
            .withSuccessHandler(function (msg) {
              showToast(msg, "success");
              closeEditModal();
              google.script.run
                .withSuccessHandler(function (data) {
                  allItems = data || [];
                  computeUniqueValues();
                  applyFiltersAndSorting();
                })
                .getMainData();
            })
            .withFailureHandler(function(error) {
              showToast("Error: " + error.message, "error");
            })
            .editItem(editingItemName, obj, token);
        }
      }

      function confirmDelete(name) {
        showConfirm(
          "Delete Item",
          "Are you sure you want to delete this item? This action cannot be undone.",
          function() {
            const token = getSessionToken();

            google.script.run
              .withSuccessHandler(function (msg) {
                showToast(msg, "success");
                backToList();
                google.script.run
                  .withSuccessHandler(function (data) {
                    allItems = data || [];
                    computeUniqueValues();
                    applyFiltersAndSorting();
                  })
                  .getMainData();
              })
              .withFailureHandler(function(error) {
                showToast("Error: " + error.message, "error");
              })
              .deleteItem(name, token);
          }
        );
      }

      // -------------------- Column Management (Creator only) --------------------

      let editingColumnIndex = -1;

      function openManageColumnsModal() {
        if (!user || user.profile !== "Creator") {
          showToast("Only Creator can manage columns.", "warning");
          return;
        }

        const modal = document.getElementById("manageColumnsModal");
        populateColumnsTable();
        modal.style.display = "flex";
      }

      function closeManageColumnsModal() {
        document.getElementById("manageColumnsModal").style.display = "none";
      }

      function populateColumnsTable() {
        const tbody = document.getElementById("columnsTableBody");
        tbody.innerHTML = "";

        for (let i = 0; i < columnConfig.length; i++) {
          const config = columnConfig[i];
          const row = document.createElement("tr");
          row.style.borderBottom = "1px solid #e5e7eb";

          const canMoveUp = i > 0;
          const canMoveDown = i < columnConfig.length - 1;

          row.innerHTML = `
            <td style="padding: 8px; text-align: center;">
              <button onclick="moveColumnUp(${i})" ${!canMoveUp ? 'disabled' : ''} style="background: none; border: none; cursor: ${canMoveUp ? 'pointer' : 'not-allowed'}; font-size: 16px; padding: 2px 4px; color: ${canMoveUp ? '#3b82f6' : '#d1d5db'};">‚ñ≤</button>
              <button onclick="moveColumnDown(${i})" ${!canMoveDown ? 'disabled' : ''} style="background: none; border: none; cursor: ${canMoveDown ? 'pointer' : 'not-allowed'}; font-size: 16px; padding: 2px 4px; color: ${canMoveDown ? '#3b82f6' : '#d1d5db'};">‚ñº</button>
            </td>
            <td style="padding: 8px;">${config.columnName}</td>
            <td style="padding: 8px;">${config.displayName || config.columnName}</td>
            <td style="padding: 8px;">${config.type || 'text'}</td>
            <td style="padding: 8px; text-align: center;">${config.showInFilter ? '‚úì' : '‚Äî'}</td>
            <td style="padding: 8px; text-align: center;">${config.showInSort ? '‚úì' : '‚Äî'}</td>
            <td style="padding: 8px;">${config.itemPlaceDisplay || '‚Äî'}</td>
            <td style="padding: 8px;">${config.specialRoleDisplay || '‚Äî'}</td>
            <td style="padding: 8px; text-align: center;">
              <button class="btn-text" onclick="openEditColumn(${i})" style="font-size: 11px; padding: 4px 8px;">Edit</button>
              <button class="btn-text" onclick="confirmDeleteColumn(${i})" style="font-size: 11px; padding: 4px 8px; color: #dc2626;">Delete</button>
            </td>
          `;

          tbody.appendChild(row);
        }
      }

      function openAddColumn() {
        editingColumnIndex = -1;
        const modal = document.getElementById("columnEditorModal");
        const title = document.getElementById("columnEditorTitle");

        title.textContent = "Add New Column";

        // Clear form
        document.getElementById("editColName").value = "";
        document.getElementById("editColDisplayName").value = "";
        document.getElementById("editColType").value = "text";
        document.getElementById("editColShowInFilter").checked = false;
        document.getElementById("editColShowInSort").checked = false;
        document.getElementById("editColItemPlace").value = "";
        document.getElementById("editColSpecialRole").value = "";

        // Enable column name field (only for new columns)
        document.getElementById("editColName").disabled = false;

        modal.style.display = "flex";
      }

      function openEditColumn(index) {
        editingColumnIndex = index;
        const config = columnConfig[index];
        const modal = document.getElementById("columnEditorModal");
        const title = document.getElementById("columnEditorTitle");

        title.textContent = "Edit Column";

        // Populate form
        document.getElementById("editColName").value = config.columnName;
        document.getElementById("editColDisplayName").value = config.displayName || config.columnName;
        document.getElementById("editColType").value = config.type || "text";
        document.getElementById("editColShowInFilter").checked = config.showInFilter || false;
        document.getElementById("editColShowInSort").checked = config.showInSort || false;
        document.getElementById("editColItemPlace").value = config.itemPlaceDisplay || "";
        document.getElementById("editColSpecialRole").value = config.specialRoleDisplay || "";

        // Disable column name field (can't rename existing columns)
        document.getElementById("editColName").disabled = true;

        modal.style.display = "flex";
      }

      function closeColumnEditor() {
        document.getElementById("columnEditorModal").style.display = "none";
      }

      function saveColumnEditor() {
        const columnName = document.getElementById("editColName").value.trim();
        const displayName = document.getElementById("editColDisplayName").value.trim();
        const type = document.getElementById("editColType").value;
        const showInFilter = document.getElementById("editColShowInFilter").checked;
        const showInSort = document.getElementById("editColShowInSort").checked;
        const itemPlace = document.getElementById("editColItemPlace").value;
        const specialRole = document.getElementById("editColSpecialRole").value;
        const token = getSessionToken();

        if (!columnName) {
          showToast("Column name is required.", "error");
          return;
        }

        if (editingColumnIndex === -1) {
          // Adding new column
          google.script.run
            .withSuccessHandler(function (msg) {
              showToast(msg, "success");
              closeColumnEditor();
              reloadColumnConfig();
            })
            .withFailureHandler(function(error) {
              showToast("Error: " + error.message, "error");
            })
            .addNewColumn(columnName, displayName, type, showInFilter, showInSort, itemPlace, specialRole, token);
        } else {
          // Editing existing column
          const updatedConfig = columnConfig.slice();
          updatedConfig[editingColumnIndex] = {
            columnName: columnName,
            displayName: displayName,
            type: type,
            showInFilter: showInFilter,
            showInSort: showInSort,
            itemPlace: itemPlace,
            itemPlaceDisplay: itemPlace,
            specialRole: specialRole,
            specialRoleDisplay: specialRole
          };

          google.script.run
            .withSuccessHandler(function (msg) {
              showToast(msg, "success");
              closeColumnEditor();
              reloadColumnConfig();
            })
            .withFailureHandler(function(error) {
              showToast("Error: " + error.message, "error");
            })
            .saveColumnConfig(updatedConfig, token);
        }
      }

      function reloadColumnConfig() {
        const token = getSessionToken();
        google.script.run
          .withSuccessHandler(function (payload) {
            columnConfig = payload.columnConfig || [];
            headers = payload.headers || [];
            allItems = payload.items || [];

            loadColumnConfig();
            computeUniqueValues();
            populateColumnsTable();
            updateChipsUI();
            applyFiltersAndSorting();
          })
          .getInitialData(token);
      }

      function moveColumnUp(index) {
        if (index <= 0) return;

        // Swap with previous item
        const temp = columnConfig[index];
        columnConfig[index] = columnConfig[index - 1];
        columnConfig[index - 1] = temp;

        const token = getSessionToken();

        // Save reordered config
        google.script.run
          .withSuccessHandler(function (msg) {
            showToast(msg, "success");
            populateColumnsTable();
          })
          .withFailureHandler(function(error) {
            showToast("Error: " + error.message, "error");
          })
          .saveColumnConfig(columnConfig, token);
      }

      function moveColumnDown(index) {
        if (index >= columnConfig.length - 1) return;

        // Swap with next item
        const temp = columnConfig[index];
        columnConfig[index] = columnConfig[index + 1];
        columnConfig[index + 1] = temp;

        const token = getSessionToken();

        // Save reordered config
        google.script.run
          .withSuccessHandler(function (msg) {
            showToast(msg, "success");
            populateColumnsTable();
          })
          .withFailureHandler(function(error) {
            showToast("Error: " + error.message, "error");
          })
          .saveColumnConfig(columnConfig, token);
      }

      function confirmDeleteColumn(index) {
        const config = columnConfig[index];
        showConfirm(
          "Delete Column",
          "Are you sure you want to delete the column '" + config.columnName + "'? This will remove the column from both the ColumnConfig and Main sheets. This action cannot be undone.",
          function() {
            deleteColumn(index);
          }
        );
      }

      function deleteColumn(index) {
        const config = columnConfig[index];
        const token = getSessionToken();

        google.script.run
          .withSuccessHandler(function (msg) {
            showToast(msg, "success");
            reloadColumnConfig();
          })
          .withFailureHandler(function(error) {
            showToast("Error: " + error.message, "error");
          })
          .deleteColumn(config.columnName, token);
      }

      function promptRenameCatalogue() {
        if (!user || user.profile !== "Creator") return;
        const current = (settings && settings.catalogName) || "";

        showPrompt(
          "Rename Catalogue",
          "Enter a new name for your catalogue:",
          current,
          function(name) {
            const token = getSessionToken();
            google.script.run
              .withSuccessHandler(function (msg) {
                showToast(msg, "success");
                google.script.run
                  .withSuccessHandler(function (s) {
                    settings = s || settings;
                    updateHeaderUI();
                  })
                  .getSettings();
              })
              .withFailureHandler(function(error) {
                showToast("Error: " + error.message, "error");
              })
              .renameCatalogue(name, token);
          }
        );
      }

      // -------------------- Init --------------------

      async function init() {
        console.log('=== App Initialization Starting ===');

        // Initialize IndexedDB
        try {
          await imageCacheDB.init();
          console.log('‚úì IndexedDB cache initialized');
        } catch (err) {
          console.warn('IndexedDB not available:', err);
        }

        // Setup lazy loading
        setupLazyLoading();

        // First, check app mode (public or private)
        google.script.run
          .withSuccessHandler(function (appSettings) {
            console.log('App mode:', appSettings.appMode);

            // If public mode, skip login and load data directly
            if (appSettings.appMode === "Public all in Viewer") {
              console.log('Public mode - loading app without authentication...');
              loadPublicApp();
              return;
            }

            // Private mode - check for existing session
            const token = getSessionToken();

            // If no token, show login screen
            if (!token) {
              showLoginScreen();
              console.log('No session token - showing login screen');
              return;
            }

            console.log('Session token found - loading app...');
            loadPrivateApp(token);
          })
          .withFailureHandler(function(error) {
            console.error('Error checking app mode:', error);
            showToast('Error loading app settings', 'error');
          })
          .getSettings();
      }

      function loadPublicApp() {
        google.script.run
          .withSuccessHandler(function (payload) {
            user = payload.user;
            settings = payload.settings;
            headers = payload.headers || [];
            allItems = payload.items || [];
            columnConfig = payload.columnConfig || [];

            console.log('Public viewer loaded:', user.email, user.profile);

            if (settings) {
              // Use deployment URL from Settings C5
              imageProxyBaseUrl = settings.deploymentUrl || "";

              if (!imageProxyBaseUrl) {
                console.warn('‚ö†Ô∏è No deployment URL configured in Settings C5! Images may not load correctly.');
                console.warn('Please add your /exec URL to Settings sheet cell C5');
              } else {
                console.log('‚úì Image proxy URL set to:', imageProxyBaseUrl);
              }

              // Update app title
              if (settings.appName) {
                document.title = settings.appName;
                document.getElementById('loginAppName').textContent = settings.appName;
              }
            }

            // Load column configuration
            loadColumnConfig();
            computeUniqueValues();
            updateHeaderUI();
            applyRoleVisibility();
            updateChipsUI();
            applyFiltersAndSorting();

            // Hide login screen and show app
            hideLoginScreen();
          })
          .withFailureHandler(function(error) {
            console.error('Error loading public app:', error);
            showToast('Error loading catalogue: ' + error.message, 'error');
          })
          .getInitialData(null);  // No token needed in public mode
      }

      function loadPrivateApp(token) {
        google.script.run
          .withSuccessHandler(function (payload) {
            user = payload.user;
            settings = payload.settings;
            headers = payload.headers || [];
            allItems = payload.items || [];
            columnConfig = payload.columnConfig || [];

            // Check if user is still authenticated
            if (!user) {
              console.log('Session expired - showing login screen');
              clearSession();
              showLoginScreen();
              return;
            }

            console.log('User authenticated:', user.email, user.profile);

            if (settings) {
              // Use deployment URL from Settings C5
              imageProxyBaseUrl = settings.deploymentUrl || "";

              if (!imageProxyBaseUrl) {
                console.warn('‚ö†Ô∏è No deployment URL configured in Settings C5! Images may not load correctly.');
                console.warn('Please add your /exec URL to Settings sheet cell C5');
              } else {
                console.log('‚úì Image proxy URL set to:', imageProxyBaseUrl);
              }

              // Update app title
              if (settings.appName) {
                document.title = settings.appName;
                document.getElementById('loginAppName').textContent = settings.appName;
              }
            }

            // Load column configuration
            loadColumnConfig();
            computeUniqueValues();
            updateHeaderUI();
            applyRoleVisibility();
            updateChipsUI();
            applyFiltersAndSorting();

            // Hide login screen and show app
            hideLoginScreen();
          })
          .withFailureHandler(function(error) {
            console.error('Error loading app:', error);
            clearSession();
            showLoginScreen();
            showToast('Error loading catalogue: ' + error.message, 'error');
          })
          .getInitialData(token);
      }

      // Event wiring
      window.onload = function () {
        // Login event handlers
        document.getElementById('loginSendCodeBtn').onclick = requestOTP;
        document.getElementById('loginVerifyBtn').onclick = verifyOTP;
        document.getElementById('loginBackBtn').onclick = backToEmailStep;
        document.getElementById('logoutBtn').onclick = logout;

        // Allow Enter key to submit
        document.getElementById('loginEmailInput').onkeypress = function(e) {
          if (e.key === 'Enter') requestOTP();
        };
        document.getElementById('loginCodeInput').onkeypress = function(e) {
          if (e.key === 'Enter') verifyOTP();
        };

        // CRUD event handlers
        document.getElementById("addBtn").onclick = function () {
          if (
            !user ||
            (user.profile !== "Creator" && user.profile !== "Editor")
          ) {
            showToast("Only Creator or Editor can add items.", "warning");
            return;
          }
          openAdd();
        };
        document.getElementById("editCancelBtn").onclick = closeEditModal;

        // Column management event handlers (Creator only)
        document.getElementById("columnsBtn").onclick = openManageColumnsModal;
        document.getElementById("manageColsCancelBtn").onclick = closeManageColumnsModal;
        document.getElementById("addColumnBtn").onclick = openAddColumn;
        document.getElementById("columnEditorCancelBtn").onclick = closeColumnEditor;
        document.getElementById("columnEditorSaveBtn").onclick = saveColumnEditor;
        document.getElementById("editCatalogBtn").onclick = promptRenameCatalogue;

        // Sheet link button (Creator only)
        document.getElementById("sheetLinkBtn").onclick = function() {
          if (settings && settings.sheetUrl) {
            window.open(settings.sheetUrl, '_blank');
          } else {
            // If no sheetUrl in settings, construct from spreadsheet ID
            const ssId = SpreadsheetApp.getActiveSpreadsheet() ? SpreadsheetApp.getActiveSpreadsheet().getId() : null;
            if (ssId) {
              window.open('https://docs.google.com/spreadsheets/d/' + ssId + '/edit', '_blank');
            } else {
              showToast("Google Sheet URL not available.", "warning");
            }
          }
        };

        // Close column modals on overlay click
        document.getElementById("manageColumnsModal").addEventListener("click", function(e) {
          if (e.target.id === "manageColumnsModal") {
            closeManageColumnsModal();
          }
        });

        document.getElementById("columnEditorModal").addEventListener("click", function(e) {
          if (e.target.id === "columnEditorModal") {
            closeColumnEditor();
          }
        });

        init();

        // Filter dropdown
        document.getElementById("filterBtn").onclick = function(e) {
          e.stopPropagation();
          toggleDropdown("filterDropdown", "filterBtn");
        };

        // Sort dropdown
        document.getElementById("sortBtn").onclick = function(e) {
          e.stopPropagation();
          toggleDropdown("sortDropdown", "sortBtn");
        };

        // Sort field radio buttons
        document.querySelectorAll('input[name="sortField"]').forEach(radio => {
          radio.onchange = function() {
            sortField = this.value;
            updateChipsUI();
            applyFiltersAndSorting();
          };
        });

        // Sort order radio buttons
        document.querySelectorAll('input[name="sortOrder"]').forEach(radio => {
          radio.onchange = function() {
            sortOrder = this.value;
            updateChipsUI();
            applyFiltersAndSorting();
          };
        });

        // Make sort items clickable (not just radio button)
        document.querySelectorAll('#sortDropdown .dropdown-item').forEach(item => {
          item.onclick = function(e) {
            if (e.target.tagName !== 'INPUT') {
              const radio = this.querySelector('input[type="radio"]');
              if (radio) {
                radio.checked = true;
                radio.onchange();
              }
            }
          };
        });

        const overlay = document.getElementById("imgOverlay");
        const closeBtn = document.getElementById("imgOverlayClose");
        if (closeBtn) {
          closeBtn.onclick = closeImageFullscreen;
        }
        if (overlay) {
          overlay.addEventListener("click", function (e) {
            if (e.target.id === "imgOverlay") {
              closeImageFullscreen();
            }
          });
        }

      };
    </script>
  </body>
</html>
